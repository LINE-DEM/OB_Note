# 编译系统学习大纲

## 核心摘要

> 系统化学习编译原理：从源代码到可执行文件的完整链路，覆盖预处理、词法分析、语法分析、语义分析、中间代码生成、代码优化、目标代码生成、汇编、链接、加载运行全流程。

---

## 学习目标

1. **理解编译全流程**：掌握 `.cpp` → `.exe` 每个阶段的工作原理
2. **动手实践**：能手写一个简单的C语言子集编译器
3. **工具链掌握**：熟练使用 MSVC 工具链（cl.exe, link.exe, dumpbin）
4. **底层原理**：理解 PE 文件格式、Windows 加载器、运行时初始化
5. **与UE对接**：将编译知识应用于理解 UE5 的编译系统

---

## 知识地图

```
┌─────────────────────────────────────────────────────────────────┐
│                        源代码 (.cpp)                             │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  0_编译系统概览    编译流水线全景、编译vs解释                      │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  1_预处理          #include展开、宏替换、条件编译                 │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  2_词法分析        Token化、正则表达式、DFA                       │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  3_语法分析        CFG、递归下降、AST构建                         │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  4_语义分析        符号表、类型检查、作用域                       │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  5_中间代码生成    IR、三地址码、SSA                              │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  6_代码优化        数据流分析、常量折叠、死代码消除               │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  7_代码生成        指令选择、寄存器分配                           │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  8_汇编            汇编器、目标文件(.obj)、COFF格式              │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  9_链接            符号解析、重定位、静态库、动态链接             │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  10_可执行文件格式  PE文件、段、导入导出表、PDB                   │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌───────────────────────────┴─────────────────────────────────────┐
│  11_加载与运行     Windows加载器、CRT初始化、main之前             │
└───────────────────────────┬─────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                        程序运行                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 阶段导航

### 第〇阶段：编译系统概览

> 建立全局视野，理解编译的整体流程

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[编译系统全景图]] | 编译流水线全景，各阶段输入输出 | 待写 |
| [[编译与解释代码]] | 编译型语言 vs 解释型语言 | 已有 |
| [[从源码到机器码的完整链路]] | .cpp→.exe 每一步详解 | 待写 |

### 第一阶段：预处理

> 源代码的文本变换阶段

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[预处理]] | 预处理器完整工作流程 | 待写 |
| [[宏展开机制]] | #define 深入解析 | 待写 |
| [[条件编译]] | #if/#ifdef/#ifndef | 待写 |
| [[头文件包含与依赖分析]] | #include 机制、防止重复包含 | 待写 |

### 第二阶段：词法分析

> 将字符流转换为Token流

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[词法分析]] | Lexer概述、Token化原理 | 待写 |
| [[正则表达式与DFA]] | 词法分析理论基础 | 待写 |
| [[Token设计]] | Token数据结构设计 | 待写 |
| [[实践_手写Lexer]] | 动手实现词法分析器 | 待写 |

### 第三阶段：语法分析

> 将Token流转换为语法树

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[语法分析]] | Parser概述 | 待写 |
| [[上下文无关文法(CFG)]] | 文法理论基础 | 待写 |
| [[递归下降解析器]] | 最实用的解析技术 | 待写 |
| [[LL(1)与LR(1)算法]] | 算法理论（理解即可） | 待写 |
| [[抽象语法树(AST)]] | AST设计与遍历 | 待写 |
| [[实践_手写Parser]] | 动手实现语法分析器 | 待写 |

### 第四阶段：语义分析

> 类型检查、符号解析

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[语义分析]] | 语义检查概述 | 待写 |
| [[符号表设计]] | 核心数据结构 | 待写 |
| [[类型系统与类型检查]] | 类型理论基础 | 待写 |
| [[作用域与名称解析]] | 变量查找机制 | 待写 |

### 第五阶段：中间代码生成

> AST到IR的转换

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[中间表示(IR)]] | IR概念与设计 | 待写 |
| [[三地址码]] | 实用IR格式 | 待写 |
| [[SSA形式]] | 现代IR表示（理解即可） | 待写 |
| [[LLVM IR简介]] | 工业级参考 | 待写 |

### 第六阶段：代码优化

> 提升代码执行效率

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[代码优化概述]] | 优化分类与策略 | 待写 |
| [[数据流分析]] | 优化的理论基础 | 待写 |
| [[常量折叠与死代码消除]] | 基本优化技术 | 待写 |
| [[MSVC优化选项详解]] | /O1 /O2 /Ox 详解 | 待写 |

### 第七阶段：代码生成

> IR到汇编的转换

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[代码生成]] | IR→汇编概述 | 待写 |
| [[指令选择]] | 选择合适的机器指令 | 待写 |
| [[寄存器分配]] | 变量到寄存器的映射 | 待写 |
| [[目标文件生成(COFF格式)]] | 生成.obj | 待写 |

### 第八阶段：汇编

> 汇编语言到机器码

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[汇编器原理]] | 汇编→机器码的过程 | 待写 |
| [[x64汇编速查]] | 常用x64指令 | 待写 |
| [[目标文件(obj)结构]] | .obj文件内部结构 | 待写 |
| [[COFF格式详解]] | Windows目标文件格式 | 待写 |

### 第九阶段：链接

> 将多个目标文件合并为可执行文件

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[链接概述]] | 链接器职责 | 待写 |
| [[符号解析与重定位]] | 核心工作原理 | 待写 |
| [[静态库与导入库]] | .lib的两种用途 | 待写 |
| [[动态链接(DLL)]] | DLL机制详解 | 待写 |
| [[链接器脚本与内存布局]] | 与STM32对比 | 待写 |

### 第十阶段：可执行文件格式

> PE文件结构详解

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[PE文件]] | PE格式概述 | 已有（空） |
| [[PE头结构详解]] | DOS头→PE头→可选头 | 待写 |
| [[段(Section)与节]] | .text/.data/.bss | 待写 |
| [[导入表与导出表]] | IAT/EAT详解 | 待写 |
| [[调试信息(PDB)]] | 符号文件 | 待写 |

### 第十一阶段：加载与运行

> 程序启动的完整流程

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[Windows加载器]] | PE加载流程 | 待写 |
| [[进程地址空间]] | 虚拟内存布局 | 待写 |
| [[DLL加载流程]] | 依赖解析 | 待写 |
| [[运行时初始化(CRT)]] | mainCRTStartup | 待写 |
| [[main之前发生了什么]] | 与Pre-Main对接 | 待写 |

---

## 实战项目

### 手写C语言子集编译器

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[项目概述]] | 编译器项目规划 | 待写 |
| [[Day01_词法分析器]] | 实现Lexer | 待写 |
| [[Day02_语法分析器]] | 实现Parser | 待写 |
| [[Day03_语义分析]] | 实现语义检查 | 待写 |
| [[Day04_代码生成]] | 生成x64汇编 | 待写 |
| [[Day05_链接与测试]] | 完成完整流程 | 待写 |

### 问题排查

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[编译问题排查手册]] | 常见编译错误解决 | 待写 |

---

## 工具链

| 笔记 | 描述 | 状态 |
|------|------|------|
| [[MSVC工具链详解]] | Visual Studio编译工具 | 待写 |
| [[cl.exe参数速查]] | 编译器参数 | 待写 |
| [[link.exe参数速查]] | 链接器参数 | 待写 |
| [[dumpbin使用指南]] | PE文件分析工具 | 待写 |
| [[WinDbg调试入门]] | Windows调试器 | 待写 |

---

## 已有资源

- [[Visual Studio 编译流程（标准格式）]] - VS完整编译流程（详细）
- [[UE编译]] - Unreal Engine编译系统
- [[Build.cs]] - UE模块构建配置

---

## 学习阶段规划

| 阶段 | 内容 | 里程碑 |
|------|------|--------|
| 一 | 0_编译系统概览 | 绘制完整编译流程图 |
| 二 | 1~4阶段（预处理到语义分析） | 完成手写Lexer+Parser |
| 三 | 5~6阶段（IR与优化） | AST转IR |
| 四 | 7~8阶段（代码生成与汇编） | 生成x64汇编 |
| 五 | 9~10阶段（链接与PE格式） | 深入理解PE文件 |
| 六 | 11阶段（加载与运行） | 完整启动流程 |
| 七 | 实战项目 | 编译简单C代码到exe |

---

## 关联知识

- [[学习路径]] - 整体学习规划
- [[前向声明]] - 减少编译依赖
- [[C++模板使用与实现细节]] - 模板对编译的影响
- [[CDO]] - UE对象实例化（与Pre-Main相关）
