

> ä»ç¡¬ä»¶åˆ°åº”ç”¨å±‚ï¼šæ¯ä¸€å±‚åœ¨åšä»€ä¹ˆï¼Ÿè°åœ¨è¿æ¥ï¼Ÿå¦‚ä½•è¿æ¥ï¼Ÿ

---

## ğŸ“Š å®Œæ•´å±‚æ¬¡ç»“æ„æ€»è§ˆå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚ (Application Layer)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä½ çš„ä»£ç : var ws = new ClientWebSocket();               â”‚  â”‚
â”‚  â”‚           await ws.ConnectAsync(uri);                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 9 å±‚: ClientWebSocket (å®¢æˆ·ç«¯å°è£…)                          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  æºç : System.Net.WebSockets.Client/ClientWebSocket.cs          â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ HTTP æ¡æ‰‹å‡çº§ (Upgrade: websocket)                           â”‚
â”‚  â€¢ ç”Ÿæˆ Sec-WebSocket-Key                                       â”‚
â”‚  â€¢ éªŒè¯ Sec-WebSocket-Accept                                    â”‚
â”‚  â€¢ åˆ›å»º ManagedWebSocket å®ä¾‹                                   â”‚
â”‚                                                                   â”‚
â”‚  å…³é”®ä»£ç :                                                       â”‚
â”‚  public async Task ConnectAsync(Uri uri, ...)                   â”‚
â”‚  {                                                               â”‚
â”‚      // 1. åˆ›å»º HTTP è¯·æ±‚                                        â”‚
â”‚      HttpRequestMessage request = new(HttpMethod.Get, uri);     â”‚
â”‚      request.Headers.Add("Upgrade", "websocket");               â”‚
â”‚      request.Headers.Add("Connection", "Upgrade");              â”‚
â”‚                                                                   â”‚
â”‚      // 2. ç”Ÿæˆå¯†é’¥                                              â”‚
â”‚      string key = Convert.ToBase64String(                       â”‚
â”‚          Guid.NewGuid().ToByteArray());                         â”‚
â”‚      request.Headers.Add("Sec-WebSocket-Key", key);             â”‚
â”‚                                                                   â”‚
â”‚      // 3. å‘é€ HTTP è¯·æ±‚ï¼ˆä½¿ç”¨åº•å±‚ HttpClientï¼‰                 â”‚
â”‚      HttpResponseMessage response =                             â”‚
â”‚          await _httpClient.SendAsync(request);                  â”‚
â”‚                                                                   â”‚
â”‚      // 4. éªŒè¯å“åº” 101 Switching Protocols                      â”‚
â”‚      if (response.StatusCode != 101) throw ...;                 â”‚
â”‚                                                                   â”‚
â”‚      // 5. è·å–åº•å±‚æµ                                            â”‚
â”‚      Stream stream = await response.Content                     â”‚
â”‚          .ReadAsStreamAsync();                                  â”‚
â”‚                                                                   â”‚
â”‚      // 6. å§”æ‰˜ç»™ ManagedWebSocket                               â”‚
â”‚      _innerWebSocket = ManagedWebSocket                         â”‚
â”‚          .CreateFromConnectedStream(stream, ...);               â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: ClientWebSocket                                       â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: WebSocket æœåŠ¡å™¨ (é€šè¿‡ HTTP Upgrade)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 8 å±‚: ManagedWebSocket (WebSocket åè®®å®ç°)                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  æºç : System.Net.WebSockets/ManagedWebSocket.cs                â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ WebSocket Frame çš„ç¼–ç /è§£ç  (RFC 6455)                       â”‚
â”‚  â€¢ Masking/Unmasking å¤„ç†                                       â”‚
â”‚  â€¢ Ping/Pong è‡ªåŠ¨å“åº” â­â­â­                                     â”‚
â”‚  â€¢ åˆ†ç‰‡æ¶ˆæ¯çš„ç»„è£…                                                â”‚
â”‚  â€¢ çŠ¶æ€æœºç®¡ç† (Connecting/Open/Closing/Closed)                  â”‚
â”‚  â€¢ å‹ç¼©æ‰©å±•æ”¯æŒ (per-message-deflate)                           â”‚
â”‚                                                                   â”‚
â”‚  å…³é”®ä»£ç  - å‘é€æ•°æ®:                                            â”‚
â”‚  private async ValueTask SendFrameAsync(                        â”‚
â”‚      MessageOpcode opcode,                                      â”‚
â”‚      bool endOfMessage,                                         â”‚
â”‚      ReadOnlyMemory<byte> payload,                              â”‚
â”‚      CancellationToken cancellationToken)                       â”‚
â”‚  {                                                               â”‚
â”‚      // 1. æ„å»º Frame Header                                     â”‚
â”‚      //    â”Œâ”€FINâ”€â”¬â”€RSVâ”€â”¬â”€Opcodeâ”€â”                               â”‚
â”‚      //    â”‚  1  â”‚ 000 â”‚  0001  â”‚ (Text)                        â”‚
â”‚      //    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚      int headerLength = WriteHeader(                            â”‚
â”‚          opcode, _sendBuffer, payload,                          â”‚
â”‚          endOfMessage, _isServer);                              â”‚
â”‚                                                                   â”‚
â”‚      // 2. å¦‚æœæ˜¯å®¢æˆ·ç«¯ï¼Œå¿…é¡» Masking                            â”‚
â”‚      //    (é˜²æ­¢ç¼“å­˜æ±¡æŸ“æ”»å‡»)                                     â”‚
â”‚      if (!_isServer)                                            â”‚
â”‚      {                                                           â”‚
â”‚          // ç”Ÿæˆ 4 å­—èŠ‚éšæœº mask key                             â”‚
â”‚          CreateMaskingKey(_sendBuffer.AsSpan(...));             â”‚
â”‚                                                                   â”‚
â”‚          // XOR æ“ä½œè¿›è¡Œ mask                                    â”‚
â”‚          ApplyMask(payload, maskKey, _sendBuffer);              â”‚
â”‚      }                                                           â”‚
â”‚                                                                   â”‚
â”‚      // 3. å†™å…¥åº•å±‚ç½‘ç»œæµ (NetworkStream)                        â”‚
â”‚      await _stream.WriteAsync(                                  â”‚
â”‚          _sendBuffer, 0,                                        â”‚
â”‚          headerLength + payload.Length);                        â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  å…³é”®ä»£ç  - æ¥æ”¶æ•°æ®:                                            â”‚
â”‚  private async ValueTask<WebSocketReceiveResult>                â”‚
â”‚      ReceiveAsyncPrivate(Memory<byte> buffer, ...)              â”‚
â”‚  {                                                               â”‚
â”‚      // 1. è§£æ Frame Header                                     â”‚
â”‚      MessageHeader header =                                     â”‚
â”‚          await ParseAndValidateHeaderAsync(...);                â”‚
â”‚                                                                   â”‚
â”‚      // 2. å¤„ç†æ§åˆ¶å¸§ (Ping/Pong/Close)                          â”‚
â”‚      if (header.Opcode == MessageOpcode.Ping)                   â”‚
â”‚      {                                                           â”‚
â”‚          // â­ è‡ªåŠ¨å“åº” Pong                                     â”‚
â”‚          await HandleReceivedPingPongAsync(                     â”‚
â”‚              header, cancellationToken);                        â”‚
â”‚          // é€’å½’ç»§ç»­æ¥æ”¶ä¸‹ä¸€ä¸ªå¸§                                  â”‚
â”‚          return await ReceiveAsyncPrivate(...);                 â”‚
â”‚      }                                                           â”‚
â”‚                                                                   â”‚
â”‚      // 3. è¯»å–æ•°æ®å¸§                                            â”‚
â”‚      int bytesRead = await ReadFromStreamAsync(                 â”‚
â”‚          _stream, buffer, header.PayloadLength);                â”‚
â”‚                                                                   â”‚
â”‚      // 4. å¦‚æœæ˜¯æœåŠ¡å™¨æ¥æ”¶ï¼Œéœ€è¦ Unmask                         â”‚
â”‚      if (_isServer && header.Masked)                            â”‚
â”‚      {                                                           â”‚
â”‚          ApplyMask(buffer.Span, header.MaskKey);                â”‚
â”‚      }                                                           â”‚
â”‚                                                                   â”‚
â”‚      return new WebSocketReceiveResult(                         â”‚
â”‚          bytesRead, header.MessageType, header.Fin);            â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  â­â­â­ Ping/Pong å¤„ç† (è°åœ¨åšï¼ŸManagedWebSocket!)                â”‚
â”‚  private async Task HandleReceivedPingPongAsync(                â”‚
â”‚      MessageHeader header, ...)                                 â”‚
â”‚  {                                                               â”‚
â”‚      if (header.Opcode == MessageOpcode.Ping)                   â”‚
â”‚      {                                                           â”‚
â”‚          // è¯»å– Ping çš„ payload                                â”‚
â”‚          byte[] pingPayload = new byte[header.PayloadLength];   â”‚
â”‚          await ReadFromStreamAsync(_stream, pingPayload);       â”‚
â”‚                                                                   â”‚
â”‚          // ç«‹å³å‘é€ Pong å¸§ (ç›¸åŒ payload)                      â”‚
â”‚          await SendFrameAsync(                                  â”‚
â”‚              MessageOpcode.Pong,                                â”‚
â”‚              endOfMessage: true,                                â”‚
â”‚              pingPayload,                                       â”‚
â”‚              CancellationToken.None);                           â”‚
â”‚      }                                                           â”‚
â”‚      else if (header.Opcode == MessageOpcode.Pong)              â”‚
â”‚      {                                                           â”‚
â”‚          // æ¥æ”¶åˆ° Pongï¼Œæ›´æ–° KeepAlive çŠ¶æ€                     â”‚
â”‚          _lastReceiveActivityTimestamp = Stopwatch              â”‚
â”‚              .GetTimestamp();                                   â”‚
â”‚      }                                                           â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: æ—  (å·²ç»è¿æ¥ï¼Œåªå¤„ç†åè®®)                             â”‚
â”‚  Ping/Pong: â­ åœ¨è¿™ä¸€å±‚è‡ªåŠ¨å¤„ç†ï¼                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 7 å±‚: HTTP åè®®å±‚ (ä»…ç”¨äº WebSocket æ¡æ‰‹)                    â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  æºç : System.Net.Http/HttpClient.cs                            â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ HTTP/1.1 è¯·æ±‚/å“åº”å¤„ç†                                        â”‚
â”‚  â€¢ ç”¨äº WebSocket çš„ HTTP Upgrade æ¡æ‰‹                           â”‚
â”‚  â€¢ å‡çº§æˆåŠŸåä¸å†ä½¿ç”¨                                            â”‚
â”‚                                                                   â”‚
â”‚  WebSocket æ¡æ‰‹æµç¨‹:                                             â”‚
â”‚                                                                   â”‚
â”‚  å®¢æˆ·ç«¯å‘é€:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ GET /chat HTTP/1.1                                     â”‚    â”‚
â”‚  â”‚ Host: server.example.com                               â”‚    â”‚
â”‚  â”‚ Upgrade: websocket                                     â”‚    â”‚
â”‚  â”‚ Connection: Upgrade                                    â”‚    â”‚
â”‚  â”‚ Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==           â”‚    â”‚
â”‚  â”‚ Sec-WebSocket-Version: 13                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â”‚  æœåŠ¡å™¨å“åº”:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ HTTP/1.1 101 Switching Protocols                       â”‚    â”‚
â”‚  â”‚ Upgrade: websocket                                     â”‚    â”‚
â”‚  â”‚ Connection: Upgrade                                    â”‚    â”‚
â”‚  â”‚ Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â”‚  éªŒè¯å¯†é’¥ç®—æ³•:                                                   â”‚
â”‚  Accept = Base64(SHA1(Key + "258EAFA5-..."))                    â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: HttpClient                                            â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: HTTP æœåŠ¡å™¨                                           â”‚
â”‚  è¿æ¥å: åº•å±‚ Socket è¢« WebSocket æ¥ç®¡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 6 å±‚: NetworkStream (ç½‘ç»œæµæŠ½è±¡)                             â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  æºç : System.Net.Sockets/NetworkStream.cs                      â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ æä¾›é¢å‘æµçš„ Socket è®¿é—®                                      â”‚
â”‚  â€¢ å®ç° Stream æŠ½è±¡ (Read/Write/ReadAsync/WriteAsync)           â”‚
â”‚  â€¢ å°è£…åº•å±‚ Socket çš„å­—èŠ‚æµæ“ä½œ                                  â”‚
â”‚                                                                   â”‚
â”‚  å…³é”®ä»£ç :                                                       â”‚
â”‚  public class NetworkStream : Stream                            â”‚
â”‚  {                                                               â”‚
â”‚      private readonly Socket _socket;                           â”‚
â”‚                                                                   â”‚
â”‚      public override async Task WriteAsync(                     â”‚
â”‚          byte[] buffer, int offset, int count, ...)             â”‚
â”‚      {                                                           â”‚
â”‚          // å§”æ‰˜ç»™åº•å±‚ Socket.SendAsync                          â”‚
â”‚          await _socket.SendAsync(                               â”‚
â”‚              new ArraySegment<byte>(buffer, offset, count),     â”‚
â”‚              SocketFlags.None);                                 â”‚
â”‚      }                                                           â”‚
â”‚                                                                   â”‚
â”‚      public override async Task<int> ReadAsync(                 â”‚
â”‚          byte[] buffer, int offset, int count, ...)             â”‚
â”‚      {                                                           â”‚
â”‚          // å§”æ‰˜ç»™åº•å±‚ Socket.ReceiveAsync                       â”‚
â”‚          return await _socket.ReceiveAsync(                     â”‚
â”‚              new ArraySegment<byte>(buffer, offset, count),     â”‚
â”‚              SocketFlags.None);                                 â”‚
â”‚      }                                                           â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: æ—  (ä½¿ç”¨å·²è¿æ¥çš„ Socket)                              â”‚
â”‚  ä½œç”¨: è®© Socket åƒæ–‡ä»¶ä¸€æ ·è¯»å†™                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 5 å±‚: Socket ç±» (.NET å°è£…)                                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  æºç : System.Net.Sockets/Socket.cs                             â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ å°è£… Berkeley Sockets API                                    â”‚
â”‚  â€¢ æä¾›æ‰˜ç®¡æ¥å£ (C# ç±»å‹å®‰å…¨)                                    â”‚
â”‚  â€¢ å¼‚æ­¥æ“ä½œæ”¯æŒ (SendAsync/ReceiveAsync)                        â”‚
â”‚  â€¢ è·¨å¹³å°æŠ½è±¡ (Windows/Linux/macOS)                             â”‚
â”‚                                                                   â”‚
â”‚  å…³é”®ä»£ç :                                                       â”‚
â”‚  public partial class Socket : IDisposable                      â”‚
â”‚  {                                                               â”‚
â”‚      // åº•å±‚å¥æŸ„ (Windows: SOCKET, Unix: fd)                     â”‚
â”‚      private SafeSocketHandle _handle;                          â”‚
â”‚                                                                   â”‚
â”‚      // è¿æ¥åˆ°æœåŠ¡å™¨                                             â”‚
â”‚      public void Connect(string host, int port)                 â”‚
â”‚      {                                                           â”‚
â”‚          EndPoint remoteEP = new IPEndPoint(                    â”‚
â”‚              IPAddress.Parse(host), port);                      â”‚
â”‚                                                                   â”‚
â”‚          // è°ƒç”¨æ“ä½œç³»ç»Ÿ connect() ç³»ç»Ÿè°ƒç”¨                       â”‚
â”‚          SocketError errorCode = SocketPal.Connect(             â”‚
â”‚              _handle,                                           â”‚
â”‚              remoteEP.Serialize());                             â”‚
â”‚                                                                   â”‚
â”‚          if (errorCode != SocketError.Success)                  â”‚
â”‚              throw new SocketException((int)errorCode);         â”‚
â”‚      }                                                           â”‚
â”‚                                                                   â”‚
â”‚      // å‘é€æ•°æ®                                                 â”‚
â”‚      public int Send(byte[] buffer, int offset,                 â”‚
â”‚                      int size, SocketFlags flags)               â”‚
â”‚      {                                                           â”‚
â”‚          // è°ƒç”¨æ“ä½œç³»ç»Ÿ send() ç³»ç»Ÿè°ƒç”¨                          â”‚
â”‚          SocketError errorCode = SocketPal.Send(                â”‚
â”‚              _handle, buffer, offset, size,                     â”‚
â”‚              flags, out int bytesTransferred);                  â”‚
â”‚                                                                   â”‚
â”‚          if (errorCode != SocketError.Success)                  â”‚
â”‚              throw new SocketException((int)errorCode);         â”‚
â”‚                                                                   â”‚
â”‚          return bytesTransferred;                               â”‚
â”‚      }                                                           â”‚
â”‚                                                                   â”‚
â”‚      // æ¥æ”¶æ•°æ®                                                 â”‚
â”‚      public int Receive(byte[] buffer, int offset,              â”‚
â”‚                         int size, SocketFlags flags)            â”‚
â”‚      {                                                           â”‚
â”‚          // è°ƒç”¨æ“ä½œç³»ç»Ÿ recv() ç³»ç»Ÿè°ƒç”¨                          â”‚
â”‚          SocketError errorCode = SocketPal.Receive(             â”‚
â”‚              _handle, buffer, offset, size,                     â”‚
â”‚              flags, out int bytesTransferred);                  â”‚
â”‚                                                                   â”‚
â”‚          if (errorCode != SocketError.Success)                  â”‚
â”‚              throw new SocketException((int)errorCode);         â”‚
â”‚                                                                   â”‚
â”‚          return bytesTransferred;                               â”‚
â”‚      }                                                           â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: Socket ç±»                                             â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: è¿œç¨‹æœåŠ¡å™¨ (IP:Port)                                  â”‚
â”‚  å¦‚ä½•è¿æ¥: è°ƒç”¨æ“ä½œç³»ç»Ÿ connect() ç³»ç»Ÿè°ƒç”¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 4 å±‚: SocketPal (å¹³å°æŠ½è±¡å±‚)                                 â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  æºç : System.Net.Sockets/SocketPal.Windows.cs (Windows)        â”‚
â”‚        System.Net.Sockets/SocketPal.Unix.cs (Unix/Linux)        â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ å¹³å°ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨å°è£…                                        â”‚
â”‚  â€¢ P/Invoke åˆ°æ“ä½œç³»ç»Ÿ API                                       â”‚
â”‚                                                                   â”‚
â”‚  Windows å®ç°:                                                   â”‚
â”‚  internal static class SocketPal                                â”‚
â”‚  {                                                               â”‚
â”‚      [DllImport("ws2_32.dll")]                                  â”‚
â”‚      internal static extern SocketError connect(                â”‚
â”‚          SafeSocketHandle socketHandle,                         â”‚
â”‚          byte[] socketAddress,                                  â”‚
â”‚          int socketAddressSize);                                â”‚
â”‚                                                                   â”‚
â”‚      [DllImport("ws2_32.dll")]                                  â”‚
â”‚      internal static extern SocketError send(                   â”‚
â”‚          SafeSocketHandle socketHandle,                         â”‚
â”‚          byte[] buffer, int offset, int size,                   â”‚
â”‚          SocketFlags socketFlags,                               â”‚
â”‚          out int bytesTransferred);                             â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  Unix/Linux å®ç°:                                                â”‚
â”‚  internal static class SocketPal                                â”‚
â”‚  {                                                               â”‚
â”‚      [DllImport("libc")]                                        â”‚
â”‚      internal static extern int connect(                        â”‚
â”‚          int sockfd,                                            â”‚
â”‚          sockaddr* addr,                                        â”‚
â”‚          int addrlen);                                          â”‚
â”‚                                                                   â”‚
â”‚      [DllImport("libc")]                                        â”‚
â”‚      internal static extern ssize_t send(                       â”‚
â”‚          int sockfd,                                            â”‚
â”‚          void* buf, size_t len,                                 â”‚
â”‚          int flags);                                            â”‚
â”‚  }                                                               â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: SocketPal                                             â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: è°ƒç”¨æ“ä½œç³»ç»Ÿ API                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 3 å±‚: æ“ä½œç³»ç»Ÿ Socket API (ç³»ç»Ÿè°ƒç”¨)                         â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  Windows: Winsock2 (ws2_32.dll)                                 â”‚
â”‚  Linux:   POSIX Socket (libc)                                   â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ socket() - åˆ›å»º socket æ–‡ä»¶æè¿°ç¬¦                             â”‚
â”‚  â€¢ connect() - å‘èµ· TCP ä¸‰æ¬¡æ¡æ‰‹                                 â”‚
â”‚  â€¢ send()/recv() - å‘é€/æ¥æ”¶æ•°æ®                                â”‚
â”‚  â€¢ close() - å…³é—­è¿æ¥                                            â”‚
â”‚                                                                   â”‚
â”‚  å…³é”®ç³»ç»Ÿè°ƒç”¨:                                                   â”‚
â”‚                                                                   â”‚
â”‚  // åˆ›å»º socket                                                  â”‚
â”‚  int sockfd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);        â”‚
â”‚  // è¿”å›æ–‡ä»¶æè¿°ç¬¦ (Windows: SOCKET handle)                      â”‚
â”‚                                                                   â”‚
â”‚  // è¿æ¥æœåŠ¡å™¨ (â­ å‘èµ· TCP ä¸‰æ¬¡æ¡æ‰‹)                             â”‚
â”‚  struct sockaddr_in server;                                     â”‚
â”‚  server.sin_family = AF_INET;                                   â”‚
â”‚  server.sin_port = htons(80);                                   â”‚
â”‚  inet_pton(AF_INET, "192.168.1.1", &server.sin_addr);           â”‚
â”‚                                                                   â”‚
â”‚  int result = connect(sockfd,                                   â”‚
â”‚                       (struct sockaddr*)&server,                â”‚
â”‚                       sizeof(server));                          â”‚
â”‚  // æ­¤æ—¶å‘ç”Ÿ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼                                       â”‚
â”‚                                                                   â”‚
â”‚  // å‘é€æ•°æ®                                                     â”‚
â”‚  char* data = "GET / HTTP/1.1\r\n";                             â”‚
â”‚  ssize_t sent = send(sockfd, data, strlen(data), 0);            â”‚
â”‚                                                                   â”‚
â”‚  // æ¥æ”¶æ•°æ®                                                     â”‚
â”‚  char buffer[1024];                                             â”‚
â”‚  ssize_t received = recv(sockfd, buffer, sizeof(buffer), 0);    â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: æ“ä½œç³»ç»Ÿå†…æ ¸                                          â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: å‘èµ· TCP ä¸‰æ¬¡æ¡æ‰‹                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 å±‚: TCP åè®® (ä¼ è¾“å±‚)                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  å®ç°: æ“ä½œç³»ç»Ÿå†…æ ¸ TCP/IP åè®®æ ˆ                                â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ å¯é ä¼ è¾“ (ç¡®è®¤ã€é‡ä¼ ã€è¶…æ—¶)                                   â”‚
â”‚  â€¢ æµé‡æ§åˆ¶ (æ»‘åŠ¨çª—å£)                                           â”‚
â”‚  â€¢ æ‹¥å¡æ§åˆ¶ (æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…)                                   â”‚
â”‚  â€¢ è¿æ¥ç®¡ç† (ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹)                                 â”‚
â”‚  â€¢ åˆ†æ®µä¸é‡ç»„                                                    â”‚
â”‚                                                                   â”‚
â”‚  â­â­â­ TCP ä¸‰æ¬¡æ¡æ‰‹ (è¿æ¥å»ºç«‹)                                   â”‚
â”‚                                                                   â”‚
â”‚  å®¢æˆ·ç«¯                          æœåŠ¡å™¨                          â”‚
â”‚    â”‚                               â”‚                             â”‚
â”‚    â”‚   SYN (seq=x)                 â”‚                             â”‚
â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  1. å®¢æˆ·ç«¯å‘é€ SYN          â”‚
â”‚    â”‚                               â”‚                             â”‚
â”‚    â”‚   SYN-ACK (seq=y, ack=x+1)    â”‚                             â”‚
â”‚    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  2. æœåŠ¡å™¨å“åº” SYN-ACK      â”‚
â”‚    â”‚                               â”‚                             â”‚
â”‚    â”‚   ACK (ack=y+1)               â”‚                             â”‚
â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  3. å®¢æˆ·ç«¯å‘é€ ACK          â”‚
â”‚    â”‚                               â”‚                             â”‚
â”‚    â”‚    ğŸ”— è¿æ¥å»ºç«‹ (ESTABLISHED)   â”‚                             â”‚
â”‚                                                                   â”‚
â”‚  TCP æ®µæ ¼å¼:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æºç«¯å£ (16 bits) â”‚ ç›®æ ‡ç«¯å£ (16 bits)                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ åºåˆ—å· (32 bits)                                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ç¡®è®¤å· (32 bits)                                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ æ•°æ®åç§» â”‚ ä¿ç•™ â”‚ æ ‡å¿—ä½ â”‚ çª—å£å¤§å°                      â”‚  â”‚
â”‚  â”‚          â”‚      â”‚SYN ACK â”‚                               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ æ ¡éªŒå’Œ           â”‚ ç´§æ€¥æŒ‡é’ˆ                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ é€‰é¡¹ (å¯é€‰)                                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ æ•°æ®                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: TCP åè®®æ ˆ (å†…æ ¸)                                     â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: å»ºç«‹ç«¯åˆ°ç«¯çš„å¯é è¿æ¥                                  â”‚
â”‚  å¦‚ä½•è¿æ¥: ä¸‰æ¬¡æ¡æ‰‹                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 å±‚: IP åè®® (ç½‘ç»œå±‚)                                       â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  å®ç°: æ“ä½œç³»ç»Ÿå†…æ ¸ IP åè®®æ ˆ                                    â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ å¯»å€ (IP åœ°å€)                                                â”‚
â”‚  â€¢ è·¯ç”± (é€‰æ‹©è½¬å‘è·¯å¾„)                                           â”‚
â”‚  â€¢ åˆ†ç‰‡ä¸é‡ç»„                                                    â”‚
â”‚  â€¢ ä¸å¯é ä¼ è¾“ (Best Effort)                                      â”‚
â”‚                                                                   â”‚
â”‚  IP æ•°æ®åŒ…æ ¼å¼ (IPv4):                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç‰ˆæœ¬ â”‚ å¤´é•¿ â”‚ æœåŠ¡ç±»å‹ â”‚ æ€»é•¿åº¦                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ æ ‡è¯†             â”‚ æ ‡å¿— â”‚ ç‰‡åç§»                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ TTL  â”‚ åè®®     â”‚ å¤´éƒ¨æ ¡éªŒå’Œ                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ æº IP åœ°å€ (192.168.1.100)                               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ç›®æ ‡ IP åœ°å€ (93.184.216.34)                             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ TCP æ®µ (ä¸Šå±‚æ•°æ®)                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: IP åè®®æ ˆ (å†…æ ¸)                                      â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: ä¸»æœºåˆ°ä¸»æœºçš„é€šä¿¡                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 0 å±‚: é“¾è·¯å±‚ + ç‰©ç†å±‚                                        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  å®ç°: ç½‘å¡é©±åŠ¨ + ç¡¬ä»¶                                           â”‚
â”‚                                                                   â”‚
â”‚  èŒè´£:                                                           â”‚
â”‚  â€¢ MAC åœ°å€å¯»å€                                                  â”‚
â”‚  â€¢ å¸§çš„å°è£…/è§£å°                                                 â”‚
â”‚  â€¢ ç‰©ç†ä¼ è¾“ (ç”µä¿¡å·/å…‰ä¿¡å·)                                      â”‚
â”‚                                                                   â”‚
â”‚  ä»¥å¤ªç½‘å¸§æ ¼å¼:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰å¯¼ç  (7 bytes) â”‚ å¸§èµ·å§‹ç¬¦ (1 byte)                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ç›®æ ‡ MAC åœ°å€ (6 bytes)                                  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ æº MAC åœ°å€ (6 bytes)                                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ç±»å‹/é•¿åº¦ (2 bytes) - 0x0800 è¡¨ç¤º IPv4                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ IP æ•°æ®åŒ… (46-1500 bytes)                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ FCS æ ¡éªŒå’Œ (4 bytes)                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  è°åœ¨è¿æ¥: ç½‘å¡ç¡¬ä»¶                                              â”‚
â”‚  è¿æ¥ä»€ä¹ˆ: ç‰©ç†ç½‘ç»œ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å…³é”®é—®é¢˜è¯¦è§£

### 1ï¸âƒ£ **è°åœ¨è¿æ¥ï¼Ÿå¦‚ä½•è¿æ¥ï¼Ÿ**

è®©æˆ‘ä»¬é€å±‚åˆ†æï¼š

#### **åº”ç”¨å±‚ï¼šClientWebSocket**

```csharp
// ä½ çš„ä»£ç 
var ws = new ClientWebSocket();
await ws.ConnectAsync(new Uri("ws://example.com:8080/chat"));

// å†…éƒ¨æµç¨‹
ClientWebSocket.ConnectAsync()
  â†“
1. åˆ›å»º HttpClient
2. å‘é€ HTTP Upgrade è¯·æ±‚
   GET /chat HTTP/1.1
   Upgrade: websocket
   Connection: Upgrade
   Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
   
3. ç­‰å¾… 101 Switching Protocols å“åº”
4. è·å–åº•å±‚ NetworkStream
5. åˆ›å»º ManagedWebSocket å®ä¾‹
```

**è°åœ¨è¿æ¥**: `ClientWebSocket.ConnectAsync()` æ–¹æ³•  
**è¿æ¥ä»€ä¹ˆ**: WebSocket æœåŠ¡å™¨  
**å¦‚ä½•è¿æ¥**: HTTP Upgrade æ¡æ‰‹

---

#### **WebSocket å±‚ï¼šManagedWebSocket**

```csharp
// ManagedWebSocket æ¥ç®¡å·²è¿æ¥çš„æµ
ManagedWebSocket.CreateFromConnectedStream(
    stream,          // ä» HTTP è¿æ¥å‡çº§æ¥çš„æµ
    isServer: false, // å®¢æˆ·ç«¯æ¨¡å¼
    subprotocol,
    keepAliveInterval
);

// ä¹‹åæ‰€æœ‰æ“ä½œéƒ½æ˜¯ WebSocket Frame
await ws.SendAsync(...);  // â†’ SendFrameAsync()
await ws.ReceiveAsync(...); // â†’ ReceiveAsyncPrivate()
```

**è°åœ¨è¿æ¥**: æ—  (ä½¿ç”¨å·²è¿æ¥çš„æµ)  
**åšä»€ä¹ˆ**: WebSocket åè®®å¤„ç† (Frame ç¼–è§£ç )

---

#### **ä¼ è¾“å±‚ï¼šSocket**

```csharp
// HttpClient å†…éƒ¨ä½¿ç”¨ Socket è¿æ¥
Socket socket = new Socket(
    AddressFamily.InterNetwork,
    SocketType.Stream,      // TCP
    ProtocolType.Tcp
);

// â­ è¿™é‡Œå‘èµ· TCP è¿æ¥
socket.Connect("example.com", 80);

// å†…éƒ¨è°ƒç”¨
SocketPal.Connect(_handle, endpoint);
  â†“
connect() ç³»ç»Ÿè°ƒç”¨
  â†“
TCP ä¸‰æ¬¡æ¡æ‰‹
```

**è°åœ¨è¿æ¥**: `Socket.Connect()` æ–¹æ³•  
**è¿æ¥ä»€ä¹ˆ**: æœåŠ¡å™¨çš„ IP:Port  
**å¦‚ä½•è¿æ¥**: è°ƒç”¨æ“ä½œç³»ç»Ÿ `connect()` ç³»ç»Ÿè°ƒç”¨ï¼Œè§¦å‘ TCP ä¸‰æ¬¡æ¡æ‰‹

---

#### **ç½‘ç»œå±‚ï¼šTCP ä¸‰æ¬¡æ¡æ‰‹**

```
æ—¶é—´è½´ï¼š

T0: å®¢æˆ·ç«¯è°ƒç”¨ socket.Connect("192.168.1.100", 8080)
      â†“
T1: å†…æ ¸å‘é€ SYN åŒ…
      SYN, seq=1000
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T2: æœåŠ¡å™¨å†…æ ¸å“åº” SYN-ACK
      â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      SYN-ACK, seq=2000, ack=1001

T3: å®¢æˆ·ç«¯å†…æ ¸å‘é€ ACK
      ACK, ack=2001
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T4: è¿æ¥å»ºç«‹ (ESTABLISHED)
      socket.Connect() è¿”å›
      ä½ çš„ä»£ç ç»§ç»­æ‰§è¡Œ
```

**è°åœ¨è¿æ¥**: TCP åè®®æ ˆ (æ“ä½œç³»ç»Ÿå†…æ ¸)  
**è¿æ¥ä»€ä¹ˆ**: å»ºç«‹å¯é çš„åŒå‘å­—èŠ‚æµ  
**å¦‚ä½•è¿æ¥**: ä¸‰æ¬¡æ¡æ‰‹

---

### 2ï¸âƒ£ **Ping/Pong è°åœ¨åšï¼Ÿæ€ä¹ˆåšï¼Ÿ**

#### **â­ Ping/Pong å®Œå…¨åœ¨ ManagedWebSocket å±‚è‡ªåŠ¨å¤„ç†ï¼**

```csharp
// ManagedWebSocket.cs æºç 

// æ¥æ”¶å¾ªç¯
private async ValueTask<WebSocketReceiveResult> 
    ReceiveAsyncPrivate(...)
{
    while (true)
    {
        // 1. è§£æ Frame Header
        MessageHeader header = await ParseAndValidateHeaderAsync();
        
        // 2. æ£€æŸ¥æ˜¯å¦æ˜¯æ§åˆ¶å¸§
        switch (header.Opcode)
        {
            case MessageOpcode.Ping:
                // â­ è‡ªåŠ¨å“åº” Pong
                await HandleReceivedPingPongAsync(header, ...);
                continue; // ä¸è¿”å›ç»™ç”¨æˆ·ï¼Œç»§ç»­æ¥æ”¶ä¸‹ä¸€å¸§
                
            case MessageOpcode.Pong:
                // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
                _lastReceiveActivityTimestamp = Stopwatch.GetTimestamp();
                continue; // ä¸è¿”å›ç»™ç”¨æˆ·
                
            case MessageOpcode.Text:
            case MessageOpcode.Binary:
                // è¿™æ‰æ˜¯ç”¨æˆ·æ•°æ®ï¼Œè¿”å›ç»™è°ƒç”¨è€…
                return new WebSocketReceiveResult(...);
        }
    }
}

// Ping/Pong å¤„ç†å‡½æ•°
private async Task HandleReceivedPingPongAsync(
    MessageHeader header, 
    CancellationToken cancellationToken)
{
    if (header.Opcode == MessageOpcode.Ping)
    {
        // 1. è¯»å– Ping çš„ payload
        byte[] pingPayload = ArrayPool<byte>.Shared.Rent(
            (int)header.PayloadLength);
        
        try
        {
            await ReadFromStreamAsync(
                _stream, 
                pingPayload.AsMemory(0, (int)header.PayloadLength),
                cancellationToken);
            
            // 2. â­ ç«‹å³å‘é€ Pong (ç›¸åŒ payload)
            await SendFrameAsync(
                MessageOpcode.Pong,
                endOfMessage: true,
                pingPayload.AsMemory(0, (int)header.PayloadLength),
                CancellationToken.None); // æ³¨æ„ï¼šä¸ä½¿ç”¨ç”¨æˆ·çš„ token
        }
        finally
        {
            ArrayPool<byte>.Shared.Return(pingPayload);
        }
    }
}

// KeepAlive å®šæ—¶å™¨ (è‡ªåŠ¨å‘é€ Ping)
private async void KeepAliveTimerCallback(object? state)
{
    try
    {
        // æ¯éš” keepAliveInterval å‘é€ä¸€æ¬¡ Ping
        await SendFrameAsync(
            MessageOpcode.Ping,
            endOfMessage: true,
            ReadOnlyMemory<byte>.Empty,
            CancellationToken.None);
        
        _lastSendActivityTimestamp = Stopwatch.GetTimestamp();
    }
    catch (Exception ex)
    {
        // Ping å¤±è´¥ï¼Œå…³é—­è¿æ¥
        await CloseAsync(
            WebSocketCloseStatus.InternalServerError,
            "KeepAlive ping failed",
            CancellationToken.None);
    }
}
```

#### **Ping/Pong å·¥ä½œæµç¨‹**

```
æ—¶é—´è½´ï¼š

T0: ManagedWebSocket åˆ›å»º
      â†“
      å¯åŠ¨ KeepAlive å®šæ—¶å™¨ (é»˜è®¤ 30 ç§’)

T30: å®šæ—¶å™¨è§¦å‘
      â†“
      SendFrameAsync(MessageOpcode.Ping, ...)
      â†“
      å‘é€ Ping Frame:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ FIN=1 Opcode=0x9 (Ping) â”‚
      â”‚ Payload: (empty)         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T31: æœåŠ¡å™¨æ”¶åˆ° Ping
      â†“
      æœåŠ¡å™¨çš„ ManagedWebSocket.ReceiveAsyncPrivate()
      è¯†åˆ«åˆ° Ping å¸§
      â†“
      æœåŠ¡å™¨è‡ªåŠ¨è°ƒç”¨ HandleReceivedPingPongAsync()
      â†“
      å‘é€ Pong Frame:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ FIN=1 Opcode=0xA (Pong) â”‚
      â”‚ Payload: (same as Ping) â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T32: å®¢æˆ·ç«¯æ”¶åˆ° Pong
      â†“
      å®¢æˆ·ç«¯çš„ ReceiveAsyncPrivate() è¯†åˆ«åˆ° Pong
      â†“
      æ›´æ–° _lastReceiveActivityTimestamp
      â†“
      ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªç”¨æˆ·æ•°æ®å¸§
```

#### **å…³é”®ç‚¹**

1. **ç”¨æˆ·æ— æ„ŸçŸ¥**ï¼šPing/Pong å®Œå…¨ç”± ManagedWebSocket è‡ªåŠ¨å¤„ç†ï¼Œä½ çš„ä»£ç ä¸ä¼šæ”¶åˆ° Ping/Pong å¸§
2. **è‡ªåŠ¨å“åº”**ï¼šæ”¶åˆ° Ping è‡ªåŠ¨å› Pongï¼Œä¸éœ€è¦ä½ å†™ä»»ä½•ä»£ç 
3. **Keep-Alive**ï¼šå®šæ—¶å™¨è‡ªåŠ¨å‘é€ Ping ä¿æŒè¿æ¥æ´»è·ƒ
4. **ä¸å ç”¨ç”¨æˆ· API**ï¼š`ReceiveAsync()` åªè¿”å› Text/Binary æ•°æ®ï¼Œæ§åˆ¶å¸§è¢«å†…éƒ¨æ¶ˆè´¹

---

### 3ï¸âƒ£ **å®Œæ•´è¿æ¥è¿‡ç¨‹æ—¶åºå›¾**

```
ä½ çš„ä»£ç               ClientWebSocket        HttpClient          Socket              TCPå†…æ ¸           æœåŠ¡å™¨
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”‚ ConnectAsync()         â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ SendAsync()        â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ (HTTP Upgrade)     â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚ Connect()        â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚ connect()          â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚ ç³»ç»Ÿè°ƒç”¨           â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ SYN            â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ SYN-ACK        â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ ACK            â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ [ESTABLISHED]  â”‚
   â”‚                        â”‚                    â”‚                  â”‚ Connected          â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
   â”‚                        â”‚                    â”‚ Connected        â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                â”‚
   â”‚                        â”‚                    â”‚ Send(HTTP)       â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚ send()             â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ HTTP Request   â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ 101 Switching  â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                    â”‚                  â”‚ recv()             â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
   â”‚                        â”‚                    â”‚ 101 Response     â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                â”‚
   â”‚                        â”‚ GetStream()        â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ CreateManaged      â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ WebSocket()        â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”             â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚      â”‚             â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚<â”€â”€â”€â”€â”€â”˜             â”‚                  â”‚                    â”‚                â”‚
   â”‚ Connected              â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”‚ SendAsync("Hello")     â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ SendFrameAsync()   â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”             â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚      â”‚ (æ„å»ºFrame) â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚<â”€â”€â”€â”€â”€â”˜             â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ WriteAsync()       â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚ (NetworkStream)    â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚ SendAsync()      â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚ send()             â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”‚ WS Frame       â”‚
   â”‚                        â”‚                    â”‚                  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

---

## ğŸ“ æ€»ç»“

### **å±‚æ¬¡èŒè´£ä¸€è§ˆè¡¨**

|å±‚æ¬¡|åç§°|ä¸»è¦èŒè´£|è°åœ¨è¿æ¥|æºç ä½ç½®|
|---|---|---|---|---|
|9|ClientWebSocket|HTTP Upgrade æ¡æ‰‹|ClientWebSocket|System.Net.WebSockets.Client|
|8|ManagedWebSocket|WebSocket åè®®ã€Ping/Pong|æ—  (ä½¿ç”¨å·²è¿æ¥æµ)|System.Net.WebSockets|
|7|HTTP|åè®®å‡çº§|HttpClient|System.Net.Http|
|6|NetworkStream|æµæŠ½è±¡|æ— |System.Net.Sockets|
|5|Socket|æ‰˜ç®¡å°è£…|Socket.Connect()|System.Net.Sockets|
|4|SocketPal|ç³»ç»Ÿè°ƒç”¨|P/Invoke|System.Net.Sockets|
|3|ç³»ç»Ÿè°ƒç”¨|connect()/send()/recv()|OS API|æ“ä½œç³»ç»Ÿ|
|2|TCP|å¯é ä¼ è¾“ã€ä¸‰æ¬¡æ¡æ‰‹|TCP åè®®æ ˆ|å†…æ ¸|
|1|IP|è·¯ç”±ã€å¯»å€|IP åè®®æ ˆ|å†…æ ¸|
|0|é“¾è·¯å±‚|å¸§ä¼ è¾“|ç½‘å¡é©±åŠ¨|ç¡¬ä»¶|

---

### **å…³é”®è¿æ¥ç‚¹**

1. **ç‰©ç†è¿æ¥**: ç½‘å¡ â†’ è·¯ç”±å™¨ â†’ äº’è”ç½‘ â†’ æœåŠ¡å™¨ç½‘å¡
2. **TCP è¿æ¥**: `Socket.Connect()` â†’ `connect()` ç³»ç»Ÿè°ƒç”¨ â†’ TCP ä¸‰æ¬¡æ¡æ‰‹
3. **HTTP è¿æ¥**: `HttpClient.SendAsync()` â†’ å‘é€ HTTP è¯·æ±‚
4. **WebSocket è¿æ¥**: HTTP 101 Upgrade â†’ ManagedWebSocket æ¥ç®¡æµ

---

### **Ping/Pong æœºåˆ¶**

- **ä½ç½®**: ManagedWebSocket å±‚ (ç¬¬ 8 å±‚)
- **å®ç°**: è‡ªåŠ¨å“åº”ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- **ç›®çš„**: ä¿æŒè¿æ¥æ´»è·ƒï¼Œæ£€æµ‹è¿æ¥çŠ¶æ€
- **é¢‘ç‡**: é»˜è®¤ 30 ç§’ (å¯é…ç½®)

---

å¸Œæœ›è¿™ä¸ªå®Œæ•´çš„å±‚æ¬¡ç»“æ„å›¾å¸®åŠ©ä½ å½»åº•ç†è§£ç½‘ç»œé€šä¿¡çš„æ¯ä¸€å±‚ï¼