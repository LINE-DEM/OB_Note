# WebSocket Frame é€šä¿—æ˜“æ‡‚å®Œå…¨è§£æ

> æŠŠå¤æ‚çš„æŠ€æœ¯æ¦‚å¿µå˜æˆä½ èƒ½ç†è§£çš„æ—¥å¸¸ç”Ÿæ´»åœºæ™¯

---

## ğŸ¬ å¼€ç¯‡æ¯”å–»ï¼šWebSocket å°±åƒå¿«é€’ç³»ç»Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼š

- **ä½ ** = WebSocket å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨/Appï¼‰
- **å•†å®¶** = WebSocket æœåŠ¡å™¨
- **å¿«é€’åŒ…è£¹** = WebSocket Frameï¼ˆæ•°æ®å¸§ï¼‰
- **å¿«é€’å•** = Frame Headerï¼ˆå¸§å¤´ï¼‰
- **åŒ…è£¹å†…å®¹** = Payloadï¼ˆæœ‰æ•ˆè½½è·ï¼‰

å½“ä½ åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ï¼Œå•†å®¶è¦æŠŠå•†å“å¯„ç»™ä½ ï¼Œå°±éœ€è¦ç”¨å¿«é€’åŒ…è£¹ã€‚WebSocket ä¼ è¾“æ•°æ®ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼

---

## ğŸ“¦ ä¸€ã€WebSocket Frame ç»“æ„è§£æ

### **å®Œæ•´çš„ Frame ç»“æ„å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WebSocket Frame                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¿«é€’å•éƒ¨åˆ† (Frame Header)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ FIN  RSV1 RSV2 RSV3  Opcode   Mask  Payload Len      â”‚  â”‚
â”‚  â”‚  1     0    0    0    0001      1      00001010       â”‚  â”‚
â”‚  â”‚  â”‚     â””â”€ä¿ç•™â”€â”˜       â”‚        â”‚         â”‚           â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚        â”‚         â””â”€é•¿åº¦10å­—èŠ‚  â”‚  â”‚
â”‚  â”‚  â”‚                    â”‚        â””â”€æ˜¯å¦åŠ å¯†              â”‚  â”‚
â”‚  â”‚  â”‚                    â””â”€ç±»å‹ï¼ˆæ–‡æœ¬/äºŒè¿›åˆ¶/Pingç­‰ï¼‰      â”‚  â”‚
â”‚  â”‚  â””â”€æ˜¯å¦æœ€åä¸€ä¸ªåŒ…                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚  æ©ç å¯†é’¥ (Masking-key) - å¯é€‰ï¼Œå®¢æˆ·ç«¯å¿…é¡»æœ‰                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4A 3F 2C 1E  (32ä½éšæœºæ•°)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚  åŒ…è£¹å†…å®¹ (Payload)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  48 65 6C 6C 6F  (å®é™…æ•°æ®ï¼Œå¯èƒ½è¢«åŠ å¯†)                â”‚  â”‚
â”‚  â”‚  "Hello" çš„åŠ å¯†ç‰ˆæœ¬                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ·ï¸ äºŒã€Frame Header å­—æ®µè¯¦è§£

### **1. FIN å­—æ®µï¼ˆ1 bitï¼‰**

**ä½œç”¨**ï¼šæ ‡è®°è¿™æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªåŒ…è£¹

**ç”Ÿæ´»æ¯”å–»**ï¼š

```
åœºæ™¯ï¼šä½ ä¹°äº†ä¸€å¥—ç™¾ç§‘å…¨ä¹¦ï¼Œå¤ªå¤§äº†ï¼Œåˆ†æˆ 3 ä¸ªåŒ…è£¹å¯„é€

åŒ…è£¹ 1: FIN=0 âŒ (è¿˜æœ‰åç»­)
      "è¿™æ˜¯ç¬¬ 1/3 ä¸ªåŒ…è£¹ï¼Œåé¢è¿˜æœ‰"
      
åŒ…è£¹ 2: FIN=0 âŒ (è¿˜æœ‰åç»­)
      "è¿™æ˜¯ç¬¬ 2/3 ä¸ªåŒ…è£¹ï¼Œåé¢è¿˜æœ‰"
      
åŒ…è£¹ 3: FIN=1 âœ… (æœ€åä¸€ä¸ª)
      "è¿™æ˜¯ç¬¬ 3/3 ä¸ªåŒ…è£¹ï¼Œæ”¶é½äº†ï¼"
```

**æŠ€æœ¯å®ç°**ï¼š

```csharp
// ManagedWebSocket.cs æºç 
byte firstByte = (byte)opcode;
if (endOfMessage) // å¦‚æœæ˜¯æœ€åä¸€ä¸ª
    firstByte |= 0x80; // FIN = 1

buffer[0] = firstByte;
```

**ä½•æ—¶ä¸º 1**ï¼š

- âœ… æ¶ˆæ¯æ²¡æœ‰åˆ†ç‰‡ï¼Œä¸€ä¸ª Frame å°±å‘å®Œ
- âœ… æ¶ˆæ¯åˆ†ç‰‡äº†ï¼Œè¿™æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡

**ä½•æ—¶ä¸º 0**ï¼š

- âŒ æ¶ˆæ¯è¢«åˆ†ç‰‡ï¼Œè¿™ä¸æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡

---

### **2. RSV1~RSV3 å­—æ®µï¼ˆå„ 1 bitï¼‰**

**ä½œç”¨**ï¼šä¿ç•™å­—æ®µï¼Œç”¨äº WebSocket æ‰©å±•

**ç”Ÿæ´»æ¯”å–»**ï¼š

```
å¿«é€’å•ä¸Šçš„"é¢„ç•™æ ä½"
å¹³æ—¶éƒ½æ˜¯ç©ºçš„ï¼ˆ000ï¼‰
åªæœ‰ç”¨ç‰¹æ®ŠæœåŠ¡æ—¶æ‰å¡«å†™

æ¯”å¦‚ï¼š
RSV1=1: å¯ç”¨å‹ç¼©æ‰©å±• (per-message-deflate)
       "è¿™ä¸ªåŒ…è£¹å†…å®¹è¢«å‹ç¼©äº†"
       
RSV2ã€RSV3: ç›®å‰æ²¡ç”¨ï¼Œä»¥åå¯èƒ½å®šä¹‰æ–°åŠŸèƒ½
```

**æ­£å¸¸æƒ…å†µ**ï¼š

```
RSV1 = 0
RSV2 = 0
RSV3 = 0
```

**å¯ç”¨å‹ç¼©æ—¶**ï¼š

```
RSV1 = 1  (è¡¨ç¤ºæ•°æ®è¢«å‹ç¼©)
RSV2 = 0
RSV3 = 0
```

---

### **3. Opcode å­—æ®µï¼ˆ4 bitsï¼‰** â­â­â­

**ä½œç”¨**ï¼šæŒ‡ç¤ºè¿™æ˜¯ä»€ä¹ˆç±»å‹çš„åŒ…è£¹

**æ‰€æœ‰ç±»å‹ä¸€è§ˆ**ï¼š

|Opcode|åå…­è¿›åˆ¶|åç§°|ç”Ÿæ´»æ¯”å–»|ç”¨é€”|
|---|---|---|---|---|
|0x0|0000|Continuation|"ç»­é›†"|åˆ†ç‰‡æ¶ˆæ¯çš„ä¸­é—´æˆ–ç»“å°¾éƒ¨åˆ†|
|0x1|0001|Text|"ä¿¡ä»¶"|æ–‡æœ¬æ¶ˆæ¯ï¼ˆUTF-8ï¼‰|
|0x2|0010|Binary|"åŒ…è£¹"|äºŒè¿›åˆ¶æ•°æ®ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰|
|0x3~0x7|-|Reserved|"é¢„ç•™"|æœªæ¥çš„æ•°æ®ç±»å‹|
|0x8|1000|Close|"åˆ†æ‰‹ä¿¡"|å…³é—­è¿æ¥|
|0x9|1001|Ping|"åœ¨å—ï¼Ÿ"|å¿ƒè·³æ£€æµ‹|
|0xA|1010|Pong|"åœ¨çš„ï¼"|å¯¹ Ping çš„å›å¤|
|0xB~0xF|-|Reserved|"é¢„ç•™"|æœªæ¥çš„æ§åˆ¶ç±»å‹|

**è¯¦ç»†è§£é‡Š**ï¼š

#### **0x1 - Text Frameï¼ˆæ–‡æœ¬æ¶ˆæ¯ï¼‰**

```
åœºæ™¯ï¼šå‘é€èŠå¤©æ¶ˆæ¯
å†…å®¹ï¼š"ä½ å¥½ï¼Œä¸–ç•Œï¼"
Opcodeï¼š0x1
Payloadï¼šUTF-8 ç¼–ç çš„æ–‡æœ¬
```

#### **0x2 - Binary Frameï¼ˆäºŒè¿›åˆ¶æ¶ˆæ¯ï¼‰**

```
åœºæ™¯ï¼šå‘é€å›¾ç‰‡
å†…å®¹ï¼šimage.jpg çš„äºŒè¿›åˆ¶æ•°æ®
Opcodeï¼š0x2
Payloadï¼šåŸå§‹å­—èŠ‚æµ
```

#### **0x0 - Continuation Frameï¼ˆç»­åŒ…ï¼‰**

```
åœºæ™¯ï¼šå‘é€ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œåˆ†æˆ 3 ä¸ªåŒ…

Frame 1: Opcode=0x2 (Binary), FIN=0
         "è¿™æ˜¯äºŒè¿›åˆ¶æ•°æ®çš„ç¬¬ 1 éƒ¨åˆ†"
         
Frame 2: Opcode=0x0 (Continuation), FIN=0
         "è¿™æ˜¯ç»­åŒ…ï¼Œç¬¬ 2 éƒ¨åˆ†"
         
Frame 3: Opcode=0x0 (Continuation), FIN=1
         "è¿™æ˜¯ç»­åŒ…ï¼Œç¬¬ 3 éƒ¨åˆ†ï¼Œç»“æŸ"
```

#### **0x9 - Ping Frameï¼ˆå¿ƒè·³æ£€æµ‹ï¼‰**

```
åœºæ™¯ï¼šæ£€æŸ¥å¯¹æ–¹æ˜¯å¦åœ¨çº¿

å®¢æˆ·ç«¯å‘é€: 
  Opcode=0x9 (Ping)
  Payload="ä½ åœ¨å—ï¼Ÿ" (å¯é€‰)
  
æœåŠ¡å™¨è‡ªåŠ¨å›å¤:
  Opcode=0xA (Pong)
  Payload="ä½ åœ¨å—ï¼Ÿ" (å¿…é¡»ç›¸åŒ)
```

#### **0x8 - Close Frameï¼ˆå…³é—­è¿æ¥ï¼‰**

```
åœºæ™¯ï¼šç»“æŸèŠå¤©

å‘é€æ–¹:
  Opcode=0x8 (Close)
  Payload: 
    [1000] - çŠ¶æ€ç ï¼ˆæ­£å¸¸å…³é—­ï¼‰
    "å†è§" - åŸå› ï¼ˆå¯é€‰ï¼‰
    
æ¥æ”¶æ–¹:
  å›å¤ Close Frame
  å…³é—­ TCP è¿æ¥
```

---

### **4. Mask å­—æ®µï¼ˆ1 bitï¼‰** ğŸ”

**ä½œç”¨**ï¼šæ ‡è®°æ•°æ®æ˜¯å¦åŠ å¯†ï¼ˆXOR æ©ç ï¼‰

**æ ¸å¿ƒè§„åˆ™**ï¼š

```
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šMask = 1 âœ… å¿…é¡»åŠ å¯†
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šMask = 0 âŒ ä¸åŠ å¯†
```

**ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯å¿…é¡»åŠ å¯†ï¼Ÿ**

```
é˜²æ­¢"ä»£ç†ç¼“å­˜æ±¡æŸ“æ”»å‡»"

ååœºæ™¯ï¼š
1. é»‘å®¢åœ¨å®¢æˆ·ç«¯å‘é€ç‰¹åˆ¶çš„ WebSocket Frame
2. ä¸­é—´çš„ä»£ç†æœåŠ¡å™¨è¯¯ä»¥ä¸ºæ˜¯ HTTP å“åº”
3. ä»£ç†ç¼“å­˜äº†è¿™ä¸ª"å‡å“åº”"
4. å…¶ä»–ç”¨æˆ·è®¿é—®æ—¶ï¼Œè¢«è¿”å›è¿™ä¸ªæ¶æ„å†…å®¹
5. æ”»å‡»æˆåŠŸï¼

è§£å†³æ–¹æ¡ˆï¼š
å®¢æˆ·ç«¯å¼ºåˆ¶ä½¿ç”¨éšæœºæ©ç åŠ å¯†
â†’ ä»£ç†æœåŠ¡å™¨çœ‹åˆ°çš„æ˜¯éšæœºæ•°æ®
â†’ æ— æ³•è§£æä¸º HTTP
â†’ æ”»å‡»å¤±è´¥
```

**ç”Ÿæ´»æ¯”å–»**ï¼š

```
å¯„å¿«é€’æ—¶çš„é˜²ä¼ªæªæ–½ï¼š

å®¢æˆ·ç«¯å¯„ä»¶ï¼š
  âœ… å¿…é¡»ç”¨æ³¡æ²«çº¸åŒ…è£¹ï¼ˆMask=1ï¼‰
  âœ… å¿…é¡»è´´é˜²ä¼ªæ ‡ç­¾ï¼ˆMasking-keyï¼‰
  â†’ é˜²æ­¢è¢«äººå·çœ‹æˆ–æ‰åŒ…
  
å•†å®¶å¯„ä»¶ï¼š
  âŒ ä¸éœ€è¦åŒ…è£…ï¼ˆMask=0ï¼‰
  â†’ å› ä¸ºå•†å®¶æ›´å¯ä¿¡
```

---

### **5. Payload Len å­—æ®µï¼ˆå¯å˜é•¿åº¦ï¼‰**

**ä½œç”¨**ï¼šæ ‡è®°æ•°æ®æœ‰å¤šé•¿

**ä¸‰ç§é•¿åº¦è¡¨ç¤ºæ³•**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒ…å†µ 1: æ•°æ®é•¿åº¦ 0~125 å­—èŠ‚                                  â”‚
â”‚                                                               â”‚
â”‚  Payload Len (7 bits)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚   0010101     â”‚  (å€¼ = 21ï¼Œè¡¨ç¤º 21 å­—èŠ‚)                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚  ç›´æ¥ç”¨è¿™ 7 ä½è¡¨ç¤ºé•¿åº¦                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒ…å†µ 2: æ•°æ®é•¿åº¦ 126~65535 å­—èŠ‚                              â”‚
â”‚                                                               â”‚
â”‚  Payload Len (7 bits)   Extended Payload Len (16 bits)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   1111110     â”‚  +   â”‚   00000000 11111010         â”‚     â”‚
â”‚  â”‚   (126)       â”‚      â”‚   (250)                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  126 è¡¨ç¤º"çœ‹åé¢ 16 ä½"    å®é™…é•¿åº¦ = 250 å­—èŠ‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒ…å†µ 3: æ•°æ®é•¿åº¦ â‰¥ 65536 å­—èŠ‚                                â”‚
â”‚                                                               â”‚
â”‚  Payload Len (7 bits)   Extended Payload Len (64 bits)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   1111111     â”‚  +   â”‚   0000...00001111101000      â”‚     â”‚
â”‚  â”‚   (127)       â”‚      â”‚   (1000)                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  127 è¡¨ç¤º"çœ‹åé¢ 64 ä½"    å®é™…é•¿åº¦ = 1000 å­—èŠ‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç å®ç°**ï¼š

```csharp
// ManagedWebSocket.cs
int payloadLength = payload.Length;

if (payloadLength < 126)
{
    // æƒ…å†µ 1ï¼šç›´æ¥ç”¨ 7 ä½
    buffer[1] = (byte)payloadLength;
    headerLength = 2;
}
else if (payloadLength <= ushort.MaxValue)
{
    // æƒ…å†µ 2ï¼š7 ä½ = 126ï¼Œåé¢è·Ÿ 16 ä½
    buffer[1] = 126;
    BinaryPrimitives.WriteUInt16BigEndian(
        buffer.Slice(2), (ushort)payloadLength);
    headerLength = 4;
}
else
{
    // æƒ…å†µ 3ï¼š7 ä½ = 127ï¼Œåé¢è·Ÿ 64 ä½
    buffer[1] = 127;
    BinaryPrimitives.WriteUInt64BigEndian(
        buffer.Slice(2), (ulong)payloadLength);
    headerLength = 10;
}
```

**ç”Ÿæ´»æ¯”å–»**ï¼š

```
å¿«é€’é‡é‡æ ‡æ³¨ï¼š

å°å¿«é€’ (0~125g):
  "é‡é‡ï¼š50g"
  â†’ ç›´æ¥å†™åœ¨å¿«é€’å•ä¸Š
  
ä¸­ç­‰å¿«é€’ (126g~65kg):
  "é‡é‡ï¼šè§é™„åŠ è¯´æ˜"
  é™„åŠ è¯´æ˜ï¼š"500g"
  â†’ éœ€è¦é¢å¤–çš„æ ‡ç­¾
  
å¤§ä»¶ (>65kg):
  "é‡é‡ï¼šè§è¯¦ç»†æ¸…å•"
  è¯¦ç»†æ¸…å•ï¼š"150kg"
  â†’ éœ€è¦æ›´å¤§çš„è¡¨æ ¼
```

---

### **6. Masking-key å­—æ®µï¼ˆ32 bits = 4 å­—èŠ‚ï¼‰**

**ä½œç”¨**ï¼šæ©ç å¯†é’¥ï¼Œç”¨äºåŠ å¯† Payload

**ä½•æ—¶å­˜åœ¨**ï¼š

- âœ… Mask=1 æ—¶ï¼ˆå®¢æˆ·ç«¯å‘é€ï¼‰
- âŒ Mask=0 æ—¶ï¼ˆæœåŠ¡å™¨å‘é€ï¼‰

**ç”Ÿæˆæ–¹æ³•**ï¼š

```csharp
// å¿…é¡»ä½¿ç”¨é«˜è´¨é‡éšæœºæ•°ç”Ÿæˆå™¨
byte[] maskingKey = new byte[4];
RandomNumberGenerator.Fill(maskingKey);

// ç¤ºä¾‹ç»“æœ
maskingKey = [0x4A, 0x3F, 0x2C, 0x1E]
```

**ç”Ÿæ´»æ¯”å–»**ï¼š

```
å°±åƒå¿«é€’çš„åŠ å¯†é”å¯†ç 

å¯„ä»¶ï¼š
  1. ä½ éšæœºç”Ÿæˆä¸€ä¸ª 4 ä½å¯†ç ï¼š4A3F
  2. ç”¨è¿™ä¸ªå¯†ç ç»™åŒ…è£¹ä¸Šé”
  3. æŠŠå¯†ç å†™åœ¨å¿«é€’å•ä¸Š
  4. å¯„å‡º
  
æ”¶ä»¶ï¼š
  1. å¿«é€’å‘˜çœ‹åˆ°å¯†ç ï¼š4A3F
  2. ç”¨è¿™ä¸ªå¯†ç è§£é”åŒ…è£¹
  3. å–å‡ºå†…å®¹
```

---

## ğŸ” ä¸‰ã€WebSocket æ©ç ç®—æ³•è¯¦è§£

### **ç®—æ³•åŸç†**

**æ ¸å¿ƒå…¬å¼**ï¼š

```
j = i MOD 4

åŠ å¯†: Encrypted[i] = Original[i] XOR MaskingKey[j]
è§£å¯†: Original[i] = Encrypted[i] XOR MaskingKey[j]
```

**ä¸ºä»€ä¹ˆè¿™ä¹ˆç®€å•ï¼Ÿ**

- XOR è¿ç®—çš„ç‰¹æ€§ï¼š`A XOR B XOR B = A`
- åŠ å¯†å’Œè§£å¯†ä½¿ç”¨åŒä¸€ä¸ªç®—æ³•
- ä¸éœ€è¦å¤æ‚çš„åŠ å¯†åº“

---

### **ä¸¾ä¾‹è¯´æ˜**

#### **åœºæ™¯ï¼šå‘é€ "Hello" è¿™ä¸ªå•è¯**

**æ­¥éª¤ 1ï¼šå‡†å¤‡æ•°æ®**

```
åŸå§‹æ•°æ® (Payload):
  "Hello"
  
ASCII ç¼–ç :
  H = 0x48 = 01001000
  e = 0x65 = 01100101
  l = 0x6C = 01101100
  l = 0x6C = 01101100
  o = 0x6F = 01101111
```

**æ­¥éª¤ 2ï¼šç”Ÿæˆéšæœºæ©ç å¯†é’¥**

```
Masking-Key (4 å­—èŠ‚):
  [0] = 0x4A = 01001010
  [1] = 0x3F = 00111111
  [2] = 0x2C = 00101100
  [3] = 0x1E = 00011110
```

**æ­¥éª¤ 3ï¼šé€å­—èŠ‚åŠ å¯†**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—èŠ‚ 0: 'H' = 0x48                                           â”‚
â”‚                                                               â”‚
â”‚  i = 0                                                        â”‚
â”‚  j = 0 MOD 4 = 0                                             â”‚
â”‚                                                               â”‚
â”‚  Original[0]     = 0x48 = 01001000                          â”‚
â”‚  MaskingKey[0]   = 0x4A = 01001010                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ XOR                    â”‚
â”‚  Encrypted[0]    = 0x02 = 00000010                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—èŠ‚ 1: 'e' = 0x65                                           â”‚
â”‚                                                               â”‚
â”‚  i = 1                                                        â”‚
â”‚  j = 1 MOD 4 = 1                                             â”‚
â”‚                                                               â”‚
â”‚  Original[1]     = 0x65 = 01100101                          â”‚
â”‚  MaskingKey[1]   = 0x3F = 00111111                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ XOR                â”‚
â”‚  Encrypted[1]    = 0x5A = 01011010                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—èŠ‚ 2: 'l' = 0x6C                                           â”‚
â”‚                                                               â”‚
â”‚  i = 2                                                        â”‚
â”‚  j = 2 MOD 4 = 2                                             â”‚
â”‚                                                               â”‚
â”‚  Original[2]     = 0x6C = 01101100                          â”‚
â”‚  MaskingKey[2]   = 0x2C = 00101100                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ XOR                â”‚
â”‚  Encrypted[2]    = 0x40 = 01000000                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—èŠ‚ 3: 'l' = 0x6C                                           â”‚
â”‚                                                               â”‚
â”‚  i = 3                                                        â”‚
â”‚  j = 3 MOD 4 = 3                                             â”‚
â”‚                                                               â”‚
â”‚  Original[3]     = 0x6C = 01101100                          â”‚
â”‚  MaskingKey[3]   = 0x1E = 00011110                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ XOR                â”‚
â”‚  Encrypted[3]    = 0x72 = 01110010                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—èŠ‚ 4: 'o' = 0x6F                                           â”‚
â”‚                                                               â”‚
â”‚  i = 4                                                        â”‚
â”‚  j = 4 MOD 4 = 0  (åˆå›åˆ°å¯†é’¥çš„ç¬¬ 0 ä¸ªå­—èŠ‚)                  â”‚
â”‚                                                               â”‚
â”‚  Original[4]     = 0x6F = 01101111                          â”‚
â”‚  MaskingKey[0]   = 0x4A = 01001010                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ XOR                â”‚
â”‚  Encrypted[4]    = 0x25 = 00100101                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ€ç»ˆç»“æœ**ï¼š

```
åŸå§‹æ•°æ®: H    e    l    l    o
         48   65   6C   6C   6F

æ©ç å¯†é’¥: 4A   3F   2C   1E   (å¾ªç¯ä½¿ç”¨)

åŠ å¯†ç»“æœ: 02   5A   40   72   25
```

**å‘é€çš„å®Œæ•´ Frame**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header:                                                      â”‚
â”‚   FIN=1, Opcode=0x1 (Text), Mask=1, Len=5                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Masking-Key:                                                â”‚
â”‚   4A 3F 2C 1E                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Encrypted Payload:                                          â”‚
â”‚   02 5A 40 72 25                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **æºç å®ç°**

```csharp
// ManagedWebSocket.cs - ApplyMask æ–¹æ³•
private static void ApplyMask(
    Span<byte> payload,           // åŸå§‹æ•°æ®
    Span<byte> maskingKey,        // 4 å­—èŠ‚å¯†é’¥
    Span<byte> output)            // è¾“å‡ºç»“æœ
{
    Debug.Assert(maskingKey.Length == 4);
    
    for (int i = 0; i < payload.Length; i++)
    {
        // j = i MOD 4
        int j = i & 3; // ç­‰ä»·äº i % 4ï¼Œä½†æ›´å¿«
        
        // output[i] = payload[i] XOR maskingKey[j]
        output[i] = (byte)(payload[i] ^ maskingKey[j]);
    }
}

// å®é™…ä½¿ç”¨
byte[] maskingKey = new byte[4];
RandomNumberGenerator.Fill(maskingKey); // ç”Ÿæˆéšæœºå¯†é’¥

ApplyMask(
    originalPayload,  // "Hello"
    maskingKey,       // [4A 3F 2C 1E]
    encryptedPayload  // [02 5A 40 72 25]
);
```

---

### **æœåŠ¡å™¨è§£å¯†è¿‡ç¨‹**

**å®Œå…¨ç›¸åŒçš„ç®—æ³•ï¼**

```csharp
// æœåŠ¡å™¨æ”¶åˆ° Frame
Frame frame = ReceiveFrame();

// è¯»å– Masking-Key
byte[] maskingKey = frame.MaskingKey; // [4A 3F 2C 1E]

// è¯»å–åŠ å¯†çš„ Payload
byte[] encryptedPayload = frame.Payload; // [02 5A 40 72 25]

// è§£å¯† (ä½¿ç”¨ç›¸åŒçš„ ApplyMask å‡½æ•°)
byte[] decryptedPayload = new byte[5];
ApplyMask(
    encryptedPayload,  // [02 5A 40 72 25]
    maskingKey,        // [4A 3F 2C 1E]
    decryptedPayload   // [48 65 6C 6C 6F] = "Hello"
);

// éªŒè¯ XOR çš„å¯é€†æ€§
// Encrypted XOR Key = Original
// 02 XOR 4A = 48 ('H') âœ…
```

---

## âœ‚ï¸ å››ã€æ¶ˆæ¯åˆ†ç‰‡è¯¦è§£

### **ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ï¼Ÿ**

**åœºæ™¯ 1ï¼šæ¶ˆæ¯å¤ªå¤§**

```
å‘é€ä¸€ä¸ª 10MB çš„è§†é¢‘æ–‡ä»¶ï¼š
  âŒ ä¸åˆ†ç‰‡ï¼šä¸€æ¬¡æ€§è¯»å…¥ 10MB åˆ°å†…å­˜
              â†’ å†…å­˜å‹åŠ›å¤§
              â†’ é˜»å¡å…¶ä»–æ“ä½œ
              
  âœ… åˆ†ç‰‡ï¼šæ¯æ¬¡å‘é€ 64KB
          â†’ å†…å­˜å ç”¨å°
          â†’ ä¸é˜»å¡
          â†’ å¯ä»¥è¾¹ç”Ÿæˆè¾¹å‘é€
```

**åœºæ™¯ 2ï¼šå®æ—¶æµå¼æ•°æ®**

```
AI èŠå¤©æœºå™¨äººå›ç­”ï¼š
  "ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œé€‚åˆå‡ºå»æ•£æ­¥..."
  
  ä¸åˆ†ç‰‡ï¼š
    ç­‰å¾…ç”Ÿæˆå®Œæ•´ç­”æ¡ˆ â†’ ä¸€æ¬¡æ€§å‘é€
    ç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿
    
  åˆ†ç‰‡ï¼š
    ç”Ÿæˆä¸€éƒ¨åˆ† â†’ ç«‹å³å‘é€
    "ä»Šå¤©å¤©æ°”"      â†’ Frame 1 âœ…
    "å¾ˆå¥½ï¼Œ"        â†’ Frame 2 âœ…
    "é€‚åˆå‡ºå»æ•£æ­¥"  â†’ Frame 3 âœ…
    ç”¨æˆ·è¾¹çœ‹è¾¹ç­‰ï¼Œä½“éªŒå¥½
```

---

### **åˆ†ç‰‡è§„åˆ™**

#### **è§„åˆ™ 1ï¼šç¬¬ä¸€ä¸ªåˆ†ç‰‡**

```
Frame 1:
  Opcode = 0x1 (Text) æˆ– 0x2 (Binary)  â† æ ‡è®°æ¶ˆæ¯ç±»å‹
  FIN = 0                                â† è¿˜æœ‰åç»­
  Payload = ç¬¬ä¸€éƒ¨åˆ†æ•°æ®
```

#### **è§„åˆ™ 2ï¼šä¸­é—´çš„åˆ†ç‰‡**

```
Frame 2, 3, ..., N-1:
  Opcode = 0x0 (Continuation)  â† ç»­åŒ…æ ‡è®°
  FIN = 0                       â† è¿˜æœ‰åç»­
  Payload = ä¸­é—´éƒ¨åˆ†æ•°æ®
```

#### **è§„åˆ™ 3ï¼šæœ€åä¸€ä¸ªåˆ†ç‰‡**

```
Frame N:
  Opcode = 0x0 (Continuation)  â† ç»­åŒ…æ ‡è®°
  FIN = 1                       â† ç»“æŸäº†
  Payload = æœ€åéƒ¨åˆ†æ•°æ®
```

---

### **å®Œæ•´ç¤ºä¾‹**

**å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼š"Hello, this is a long message that needs fragmentation"**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame 1 (ç¬¬ä¸€ä¸ªåˆ†ç‰‡)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FIN = 0          (è¿˜æœ‰åç»­)                                  â”‚
â”‚ Opcode = 0x1     (Text - æ ‡è®°è¿™æ˜¯æ–‡æœ¬æ¶ˆæ¯)                   â”‚
â”‚ Payload = "Hello, this is "                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame 2 (ä¸­é—´åˆ†ç‰‡)                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FIN = 0          (è¿˜æœ‰åç»­)                                  â”‚
â”‚ Opcode = 0x0     (Continuation - ç»­åŒ…)                      â”‚
â”‚ Payload = "a long message "                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame 3 (æœ€åä¸€ä¸ªåˆ†ç‰‡)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FIN = 1          (ç»“æŸäº†ï¼)                                  â”‚
â”‚ Opcode = 0x0     (Continuation - ç»­åŒ…)                      â”‚
â”‚ Payload = "that needs fragmentation"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¥æ”¶ç«¯é‡ç»„**ï¼š

```
æ”¶åˆ° Frame 1: Opcode=0x1, FIN=0
  â†’ å¼€å§‹ä¸€ä¸ªæ–°æ¶ˆæ¯
  â†’ ç±»å‹ï¼šText
  â†’ ç¼“å­˜ï¼š"Hello, this is "
  
æ”¶åˆ° Frame 2: Opcode=0x0, FIN=0
  â†’ æ˜¯ç»­åŒ…ï¼Œè¿½åŠ åˆ°ç¼“å­˜
  â†’ ç¼“å­˜ï¼š"Hello, this is a long message "
  
æ”¶åˆ° Frame 3: Opcode=0x0, FIN=1
  â†’ æ˜¯ç»­åŒ…ï¼Œè¿½åŠ åˆ°ç¼“å­˜
  â†’ FIN=1ï¼Œæ¶ˆæ¯å®Œæˆï¼
  â†’ æœ€ç»ˆç»“æœï¼š"Hello, this is a long message that needs fragmentation"
```

---

### **æ§åˆ¶å¸§å¯ä»¥æ’å…¥ï¼** â­

**é‡è¦è§„åˆ™**ï¼šPing/Pong å¯ä»¥æ’å…¥åœ¨åˆ†ç‰‡è¿‡ç¨‹ä¸­

```
æ—¶é—´è½´ï¼š

T0: å‘é€ Frame 1 (Data, FIN=0)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T1: å‘é€ Frame 2 (Data, FIN=0)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T2: æ”¶åˆ° Ping Frame
    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
T3: ç«‹å³å‘é€ Pong Frame  â­ æ’å…¥ï¼
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
    
T4: ç»§ç»­å‘é€ Frame 3 (Data, FIN=0)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
    
T5: å‘é€ Frame 4 (Data, FIN=1)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
```

**ä¸ºä»€ä¹ˆå…è®¸æ’å…¥ï¼Ÿ**

```
å¦‚æœä¸å…è®¸ï¼š

å‘é€å¤§æ–‡ä»¶ (100MB)
  â†’ åˆ†æˆ 10,000 ä¸ª Frame
  â†’ éœ€è¦ 10 ç§’å‘é€å®Œ
  â†’ æœŸé—´ä¸èƒ½å“åº” Ping
  â†’ å¯¹æ–¹ä»¥ä¸ºè¿æ¥æ–­äº†
  â†’ å…³é—­è¿æ¥
  â†’ ğŸ’¥ å¤±è´¥ï¼

å…è®¸æ’å…¥ï¼š
  â†’ éšæ—¶å¯ä»¥å“åº” Ping
  â†’ è¿æ¥ä¿æŒæ´»è·ƒ
  â†’ âœ… æˆåŠŸï¼
```

---

## ğŸ›ï¸ äº”ã€æ§åˆ¶ç±» Frame è¯¦è§£

### **1. Close Frame (0x8) - å…³é—­è¿æ¥**

**ç»“æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header:                                                      â”‚
â”‚   FIN=1, Opcode=0x8 (Close)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload (å¯é€‰):                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Status Code (2 bytes, Big-Endian)                   â”‚   â”‚
â”‚   â”‚   03 E8  (1000 = æ­£å¸¸å…³é—­)                           â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚ Reason (UTF-8 æ–‡æœ¬)                                  â”‚   â”‚
â”‚   â”‚   "Goodbye"                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¸¸è§çŠ¶æ€ç **ï¼š

|çŠ¶æ€ç |åç§°|å«ä¹‰|ç¤ºä¾‹|
|---|---|---|---|
|1000|Normal Closure|æ­£å¸¸å…³é—­|ç”¨æˆ·ç‚¹å‡»"é€€å‡ºèŠå¤©"|
|1001|Going Away|ç«¯ç‚¹ç¦»å¼€|æµè§ˆå™¨æ ‡ç­¾é¡µå…³é—­|
|1002|Protocol Error|åè®®é”™è¯¯|æ”¶åˆ°æ ¼å¼é”™è¯¯çš„ Frame|
|1003|Unsupported Data|ä¸æ”¯æŒçš„æ•°æ®|åªæ”¯æŒæ–‡æœ¬ï¼Œå´æ”¶åˆ°äºŒè¿›åˆ¶|
|1007|Invalid Payload|æ— æ•ˆæ•°æ®|UTF-8 è§£ç å¤±è´¥|
|1008|Policy Violation|è¿åç­–ç•¥|å‘é€äº†è¢«ç¦æ­¢çš„å†…å®¹|
|1009|Message Too Big|æ¶ˆæ¯è¿‡å¤§|è¶…è¿‡æœåŠ¡å™¨é™åˆ¶|
|1011|Internal Error|æœåŠ¡å™¨å†…éƒ¨é”™è¯¯|æ•°æ®åº“è¿æ¥å¤±è´¥|

**å®Œæ•´æµç¨‹**ï¼š

```
å®¢æˆ·ç«¯æƒ³å…³é—­è¿æ¥ï¼š

Step 1: å®¢æˆ·ç«¯å‘é€ Close Frame
        Opcode=0x8
        Payload: 1000 "æ­£å¸¸å…³é—­"
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

Step 2: æœåŠ¡å™¨æ”¶åˆ°åï¼Œå›å¤ Close Frame
        Opcode=0x8
        Payload: 1000 "æ­£å¸¸å…³é—­" (å›æ˜¾)
        â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Step 3: åŒæ–¹å…³é—­åº•å±‚ TCP è¿æ¥
        å®¢æˆ·ç«¯: socket.Close()
        æœåŠ¡å™¨: socket.Close()
```

**æºç å®ç°**ï¼š

```csharp
// ManagedWebSocket.cs - CloseAsync
public async Task CloseAsync(
    WebSocketCloseStatus closeStatus,
    string statusDescription,
    CancellationToken cancellationToken)
{
    // 1. æ„å»º Close Frame
    byte[] closePayload = new byte[2 + Encoding.UTF8.GetByteCount(statusDescription)];
    
    // å†™å…¥çŠ¶æ€ç  (Big-Endian)
    BinaryPrimitives.WriteUInt16BigEndian(
        closePayload.AsSpan(0, 2),
        (ushort)closeStatus);
    
    // å†™å…¥åŸå› 
    Encoding.UTF8.GetBytes(statusDescription, 0, 
        statusDescription.Length, closePayload, 2);
    
    // 2. å‘é€ Close Frame
    await SendFrameAsync(
        MessageOpcode.Close,
        endOfMessage: true,
        closePayload,
        cancellationToken);
    
    // 3. ç­‰å¾…å¯¹æ–¹çš„ Close Frame
    WebSocketReceiveResult result = await ReceiveAsync(...);
    
    // 4. å…³é—­ TCP è¿æ¥
    _stream.Close();
}
```

---

### **2. Ping Frame (0x9) - å¿ƒè·³æ£€æµ‹** ğŸ’“

**ä½œç”¨**ï¼š

1. æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿
2. ä¿æŒè¿æ¥æ´»è·ƒï¼ˆé˜²æ­¢è¢«ä¸­é—´è®¾å¤‡æ–­å¼€ï¼‰
3. æµ‹é‡å¾€è¿”å»¶è¿Ÿï¼ˆRTTï¼‰

**ç»“æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header:                                                      â”‚
â”‚   FIN=1, Opcode=0x9 (Ping)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload (å¯é€‰ï¼Œæœ€å¤š 125 å­—èŠ‚):                              â”‚
â”‚   "Are you there?"                                           â”‚
â”‚   æˆ–è€…ï¼šå½“å‰æ—¶é—´æˆ³ï¼ˆç”¨äºæµ‹é‡å»¶è¿Ÿï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹ 1ï¼šç®€å•å¿ƒè·³**

```
æ¯ 30 ç§’å‘é€ä¸€æ¬¡ Pingï¼š

å®šæ—¶å™¨è§¦å‘
  â†“
å‘é€ Ping Frame
  Opcode=0x9
  Payload: (ç©º)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

ç­‰å¾… Pong å“åº”
  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Opcode=0xA
  Payload: (ç©º)

æ›´æ–°æ´»åŠ¨æ—¶é—´æˆ³
  lastActiveTime = Now
```

**ç¤ºä¾‹ 2ï¼šæµ‹é‡å»¶è¿Ÿ**

```
å‘é€ Pingï¼Œæºå¸¦æ—¶é—´æˆ³ï¼š

T0: å‘é€ Ping
    Opcode=0x9
    Payload: "1705996800000" (å½“å‰æ—¶é—´æ¯«ç§’)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’

T1: æ”¶åˆ° Pong
    â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Opcode=0xA
    Payload: "1705996800000" (ç›¸åŒæ—¶é—´æˆ³)

è®¡ç®—å»¶è¿Ÿ:
    RTT = T1 - T0 = 15ms
```

**æºç å®ç°**ï¼š

```csharp
// ManagedWebSocket.cs - KeepAlive å®šæ—¶å™¨
private Timer _keepAliveTimer;

private void StartKeepAliveTimer()
{
    _keepAliveTimer = new Timer(
        KeepAliveTimerCallback,
        null,
        _keepAliveInterval,      // å»¶è¿Ÿå¯åŠ¨
        _keepAliveInterval       // é‡å¤é—´éš”
    );
}

private async void KeepAliveTimerCallback(object state)
{
    try
    {
        // å‘é€ Ping Frame
        await SendFrameAsync(
            MessageOpcode.Ping,
            endOfMessage: true,
            ReadOnlyMemory<byte>.Empty,  // ç©º Payload
            CancellationToken.None);
        
        _lastSendActivityTimestamp = Stopwatch.GetTimestamp();
    }
    catch (Exception ex)
    {
        // Ping å¤±è´¥ï¼Œå…³é—­è¿æ¥
        await CloseAsync(
            WebSocketCloseStatus.InternalServerError,
            "KeepAlive ping failed",
            CancellationToken.None);
    }
}
```

---

### **3. Pong Frame (0xA) - å¿ƒè·³å“åº”** ğŸ’—

**ä½œç”¨**ï¼š

1. å“åº” Ping Frame
2. ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘é€ï¼ˆå•æ–¹é¢å¿ƒè·³ï¼‰

**è§„åˆ™**ï¼š

```
æ”¶åˆ° Ping åï¼š
  âœ… å¿…é¡»ç«‹å³å‘é€ Pong
  âœ… Pong çš„ Payload å¿…é¡»å’Œ Ping å®Œå…¨ç›¸åŒ
  âœ… å¦‚æœæ”¶åˆ°å¤šä¸ª Ping è¿˜æ²¡æ¥å¾—åŠå›å¤ï¼Œ
     åªéœ€å›å¤æœ€åä¸€ä¸ª Ping å³å¯
```

**ç»“æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header:                                                      â”‚
â”‚   FIN=1, Opcode=0xA (Pong)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload:                                                     â”‚
â”‚   (å¿…é¡»å’Œæ”¶åˆ°çš„ Ping çš„ Payload å®Œå…¨ç›¸åŒ)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç å®ç°**ï¼š

```csharp
// ManagedWebSocket.cs - å¤„ç† Ping
private async Task HandleReceivedPingPongAsync(
    MessageHeader header,
    CancellationToken cancellationToken)
{
    if (header.Opcode == MessageOpcode.Ping)
    {
        // 1. è¯»å– Ping çš„ Payload
        byte[] pingPayload = ArrayPool<byte>.Shared.Rent(
            (int)header.PayloadLength);
        
        try
        {
            await ReadFromStreamAsync(
                _stream,
                pingPayload.AsMemory(0, (int)header.PayloadLength),
                cancellationToken);
            
            // 2. â­ ç«‹å³å‘é€ Pong (ç›¸åŒ Payload)
            await SendFrameAsync(
                MessageOpcode.Pong,
                endOfMessage: true,
                pingPayload.AsMemory(0, (int)header.PayloadLength),
                CancellationToken.None);
        }
        finally
        {
            ArrayPool<byte>.Shared.Return(pingPayload);
        }
    }
    else if (header.Opcode == MessageOpcode.Pong)
    {
        // æ”¶åˆ° Pongï¼Œæ›´æ–°æ´»åŠ¨æ—¶é—´
        _lastReceiveActivityTimestamp = Stopwatch.GetTimestamp();
    }
}
```

---

## ğŸ¬ å…­ã€å®Œæ•´ç¤ºä¾‹ï¼šå‘é€ "Hello" æ¶ˆæ¯

### **åœºæ™¯ï¼šæµè§ˆå™¨å‘é€ "Hello" åˆ°æœåŠ¡å™¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ä½ çš„ä»£ç                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ await ws.SendAsync(                                          â”‚
â”‚     Encoding.UTF8.GetBytes("Hello"),                         â”‚
â”‚     WebSocketMessageType.Text,                               â”‚
â”‚     endOfMessage: true,                                      â”‚
â”‚     CancellationToken.None);                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: ManagedWebSocket.SendFrameAsync()                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2.1 æ„å»º Header                                              â”‚
â”‚     â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚     â”‚ 1 â”‚ 0 â”‚ 0 â”‚ 0 â”‚ 0001 â”‚ 1 â”‚ 00000101 â”‚                â”‚
â”‚     â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚      FIN RSV    Opcode  Mask   Len=5                        â”‚
â”‚                                                               â”‚
â”‚ 2.2 ç”Ÿæˆéšæœº Masking-Key                                     â”‚
â”‚     [4A 3F 2C 1E]                                            â”‚
â”‚                                                               â”‚
â”‚ 2.3 XOR åŠ å¯† Payload                                         â”‚
â”‚     Original:  H    e    l    l    o                        â”‚
â”‚               48   65   6C   6C   6F                         â”‚
â”‚     Mask:     4A   3F   2C   1E   (å¾ªç¯)                    â”‚
â”‚     XOR:      02   5A   40   72   25                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: å®Œæ•´çš„ Frame (å®é™…å‘é€çš„å­—èŠ‚)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 81 85 4A 3F 2C 1E 02 5A 40 72 25                            â”‚
â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚ â”‚  â”‚    Masking-Key    Encrypted Payload                    â”‚
â”‚ â”‚  â””â”€ Mask=1, Len=5                                         â”‚
â”‚ â””â”€ FIN=1, Opcode=0x1                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ ç½‘ç»œä¼ è¾“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: æœåŠ¡å™¨æ¥æ”¶ (ManagedWebSocket.ReceiveAsync)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4.1 è¯»å– Header                                              â”‚
â”‚     81 â†’ FIN=1, Opcode=0x1 (Text)                           â”‚
â”‚     85 â†’ Mask=1, Len=5                                      â”‚
â”‚                                                               â”‚
â”‚ 4.2 è¯»å– Masking-Key                                         â”‚
â”‚     [4A 3F 2C 1E]                                            â”‚
â”‚                                                               â”‚
â”‚ 4.3 è¯»å–åŠ å¯†çš„ Payload                                       â”‚
â”‚     [02 5A 40 72 25]                                         â”‚
â”‚                                                               â”‚
â”‚ 4.4 XOR è§£å¯†                                                 â”‚
â”‚     Encrypted: 02   5A   40   72   25                       â”‚
â”‚     Mask:      4A   3F   2C   1E   (å¾ªç¯)                   â”‚
â”‚     XOR:       48   65   6C   6C   6F                        â”‚
â”‚     Result:    H    e    l    l    o    âœ…                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ€»ç»“ï¼šæ ¸å¿ƒè¦ç‚¹

### **1. Frame ç»“æ„è®°å¿†å£è¯€**

```
ä¸€ä¸ª FIN æ ‡ç»“å°¾
ä¸‰ä¸ª RSV ç•™æ‰©å±•
å››ä½ Opcode å®šç±»å‹
ä¸€ä½ Mask è¦åŠ å¯†
ä¸ƒä½é•¿åº¦å¯æ‰©å±•
å››å­—èŠ‚ Key æ¥æ©ç›–
æœ€åæ‰æ˜¯çœŸæ•°æ®
```

### **2. å¿…é¡»è®°ä½çš„è§„åˆ™**

âœ… **å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šå¿…é¡» Mask=1** âœ… **æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šå¿…é¡» Mask=0** âœ… **Ping å¿…é¡»å› Pongï¼ŒPayload ç›¸åŒ** âœ… **åˆ†ç‰‡ï¼šç¬¬ä¸€ä¸ªæ ‡ç±»å‹ï¼Œåé¢éƒ½æ˜¯ 0x0** âœ… **FIN=1 æ‰æ˜¯å®Œæ•´æ¶ˆæ¯**

### **3. Opcode é€ŸæŸ¥è¡¨**

|å€¼|åç§°|ç”¨é€”|FIN|
|---|---|---|---|
|0x0|Continuation|åˆ†ç‰‡ç»­åŒ…|0/1|
|0x1|Text|UTF-8 æ–‡æœ¬|é€šå¸¸ 1|
|0x2|Binary|äºŒè¿›åˆ¶æ•°æ®|é€šå¸¸ 1|
|0x8|Close|å…³é—­è¿æ¥|å¿…é¡» 1|
|0x9|Ping|å¿ƒè·³æ£€æµ‹|å¿…é¡» 1|
|0xA|Pong|å¿ƒè·³å“åº”|å¿…é¡» 1|

### **4. æ©ç ç®—æ³•**

```
åŠ å¯† = åŸæ–‡ XOR å¯†é’¥
è§£å¯† = å¯†æ–‡ XOR å¯†é’¥

j = i MOD 4
result[i] = data[i] XOR key[j]
```

---

å¸Œæœ›è¿™ä»½é€šä¿—æ˜“æ‡‚çš„è§£æå¸®ä½ å½»åº•ç†è§£ WebSocket Frameï¼ğŸ‰