æˆ‘æ¥ä¸ºä½ åˆ›å»ºä¸€ä¸ª**ä»åº•å±‚åˆ°é¡¶å±‚**çš„å®Œæ•´ç½‘ç»œå±‚æ¬¡ç»“æ„å›¾ï¼Œç»“åˆæºç æ·±å…¥ç†è§£æ¯ä¸€å±‚çš„èŒè´£å’Œè¿æ¥è¿‡ç¨‹ï¼å®Œç¾ï¼ç°åœ¨æˆ‘æ¥ä¸ºä½ åˆ›å»ºä¸€ä¸ª**å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„å›¾**ï¼Œä»ç‰©ç†å±‚ä¸€ç›´åˆ° ClientWebSocketï¼Œç»“åˆæºç æ·±å…¥è§£ææ¯ä¸€å±‚çš„èŒè´£å’Œè¿æ¥è¿‡ç¨‹ã€‚å®Œæˆï¼æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†ä¸€ä¸ª**è¶…è¯¦ç»†çš„ç½‘ç»œå±‚æ¬¡ç»“æ„å›¾**ï¼Œä»ç‰©ç†å±‚ä¸€ç›´åˆ° ClientWebSocketï¼ŒåŒ…å«æºç è§£æã€‚

## ğŸ¯ **æ ¸å¿ƒè¦ç‚¹æ€»ç»“**

### **1. å®Œæ•´çš„ 9 å±‚ç»“æ„**

```
ç¬¬ 9 å±‚: ClientWebSocket       â† ä½ çš„ä»£ç åœ¨è¿™é‡Œ
ç¬¬ 8 å±‚: ManagedWebSocket      â† â­ Ping/Pong åœ¨è¿™é‡Œï¼
ç¬¬ 7 å±‚: HTTP                  â† åªç”¨äºæ¡æ‰‹
ç¬¬ 6 å±‚: NetworkStream         â† æµæŠ½è±¡
ç¬¬ 5 å±‚: Socket                â† .NET å°è£…
ç¬¬ 4 å±‚: SocketPal             â† ç³»ç»Ÿè°ƒç”¨å°è£…
ç¬¬ 3 å±‚: ç³»ç»Ÿè°ƒç”¨ API          â† connect()/send()/recv()
ç¬¬ 2 å±‚: TCP                   â† â­ ä¸‰æ¬¡æ¡æ‰‹åœ¨è¿™é‡Œï¼
ç¬¬ 1 å±‚: IP                    â† è·¯ç”±å¯»å€
ç¬¬ 0 å±‚: é“¾è·¯å±‚/ç‰©ç†å±‚         â† ç½‘å¡ç¡¬ä»¶
```

---

### **2. è°åœ¨è¿æ¥ï¼Ÿä¸‰ä¸ªå…³é”®è¿æ¥ç‚¹**

#### **â‘  TCP è¿æ¥ (ç¬¬ 2-3 å±‚)**

```csharp
// ä½ çš„ä»£ç 
var ws = new ClientWebSocket();
await ws.ConnectAsync(new Uri("ws://example.com:8080"));

// å†…éƒ¨è°ƒç”¨é“¾
ClientWebSocket.ConnectAsync()
  â†’ HttpClient.SendAsync()
  â†’ Socket.Connect("example.com", 8080)  // â­ è¿™é‡Œï¼
  â†’ connect() ç³»ç»Ÿè°ƒç”¨
  â†’ TCP ä¸‰æ¬¡æ¡æ‰‹
    SYN â†’
    â† SYN-ACK
    ACK â†’
    [ESTABLISHED]
```

**è°åœ¨è¿æ¥**: `Socket.Connect()` â†’ è§¦å‘ TCP ä¸‰æ¬¡æ¡æ‰‹  
**è¿æ¥ä»€ä¹ˆ**: æœåŠ¡å™¨çš„ `IP:Port`  
**åœ¨å“ªä¸€å±‚**: TCP å±‚ (ç¬¬ 2 å±‚)

---

#### **â‘¡ HTTP å‡çº§ (ç¬¬ 7 å±‚)**

```http
å®¢æˆ·ç«¯å‘é€ï¼š
GET /chat HTTP/1.1
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==

æœåŠ¡å™¨å“åº”ï¼š
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```

**è°åœ¨è¿æ¥**: `ClientWebSocket.ConnectAsync()`  
**è¿æ¥ä»€ä¹ˆ**: WebSocket æœåŠ¡å™¨ (é€šè¿‡ HTTP åè®®å‡çº§)  
**åœ¨å“ªä¸€å±‚**: HTTP å±‚ (ç¬¬ 7 å±‚)

---

#### **â‘¢ WebSocket æ¥ç®¡ (ç¬¬ 8 å±‚)**

```csharp
// ClientWebSocket.cs æºç 
Stream stream = await response.Content.ReadAsStreamAsync();

// åˆ›å»º ManagedWebSocketï¼Œæ¥ç®¡å·²è¿æ¥çš„ TCP æµ
_innerWebSocket = ManagedWebSocket.CreateFromConnectedStream(
    stream,
    isServer: false,
    subprotocol,
    keepAliveInterval
);
```

**è°åœ¨è¿æ¥**: æ—  (ä½¿ç”¨å·²å»ºç«‹çš„ TCP è¿æ¥)  
**åšä»€ä¹ˆ**: WebSocket Frame ç¼–è§£ç   
**åœ¨å“ªä¸€å±‚**: WebSocket å±‚ (ç¬¬ 8 å±‚)

---

### **3. â­â­â­ Ping/Pong å®Œå…¨åœ¨ ManagedWebSocket å±‚è‡ªåŠ¨å¤„ç†**

#### **å®ç°ä½ç½®**

```
æºç : System.Net.WebSockets/src/ManagedWebSocket.cs
è¡Œæ•°: ~1500-1600 è¡Œ
```

#### **å·¥ä½œåŸç†**

```csharp
// æ¥æ”¶å¾ªç¯
while (true) {
    MessageHeader header = await ParseAndValidateHeaderAsync();
    
    if (header.Opcode == MessageOpcode.Ping) {
        // â­ è‡ªåŠ¨å‘é€ Pongï¼Œç”¨æˆ·ä¸ä¼šæ”¶åˆ°
        await HandleReceivedPingPongAsync(header);
        continue; // ä¸è¿”å›ï¼Œç»§ç»­æ¥æ”¶ä¸‹ä¸€å¸§
    }
    
    if (header.Opcode == MessageOpcode.Pong) {
        // æ›´æ–°æ´»åŠ¨æ—¶é—´æˆ³
        _lastReceiveActivityTimestamp = Stopwatch.GetTimestamp();
        continue; // ä¸è¿”å›
    }
    
    // åªæœ‰ Text/Binary æ•°æ®æ‰è¿”å›ç»™ç”¨æˆ·
    return new WebSocketReceiveResult(...);
}
```

#### **KeepAlive å®šæ—¶å™¨**

```csharp
// æ¯ 30 ç§’è‡ªåŠ¨å‘é€ Ping
private Timer _keepAliveTimer;

_keepAliveTimer = new Timer(
    KeepAliveTimerCallback,
    null,
    keepAliveInterval,
    keepAliveInterval
);

private async void KeepAliveTimerCallback() {
    await SendFrameAsync(
        MessageOpcode.Ping,
        endOfMessage: true,
        ReadOnlyMemory<byte>.Empty
    );
}
```

#### **å…³é”®ç‚¹**

- âœ… **ç”¨æˆ·æ— æ„ŸçŸ¥**: ä½ çš„ `ReceiveAsync()` æ°¸è¿œä¸ä¼šæ”¶åˆ° Ping/Pong å¸§
- âœ… **è‡ªåŠ¨å“åº”**: æ”¶åˆ° Ping è‡ªåŠ¨å› Pongï¼Œæ— éœ€ä»»ä½•ä»£ç 
- âœ… **è‡ªåŠ¨å‘é€**: å®šæ—¶å™¨æ¯ 30 ç§’è‡ªåŠ¨å‘ Ping ä¿æ´»
- âœ… **å®Œå…¨é€æ˜**: ä¸å ç”¨ä½ çš„ APIï¼Œä¸å½±å“ä½ çš„æ•°æ®æµ

---

### **4. å®Œæ•´çš„æ•°æ®æµåŠ¨è·¯å¾„**

#### **å‘é€æ•°æ®æµç¨‹**

```
ä½ çš„ä»£ç :
  await ws.SendAsync(buffer, WebSocketMessageType.Text, true, ct);
    â†“
ManagedWebSocket.SendAsync()
    â†“
ManagedWebSocket.SendFrameAsync()
  â€¢ æ„å»º Frame Header (FIN, Opcode, Length)
  â€¢ ç”Ÿæˆ Masking Key (å®¢æˆ·ç«¯å¿…é¡»)
  â€¢ XOR Masking (payload ^ maskKey)
    â†“
NetworkStream.WriteAsync()
    â†“
Socket.SendAsync()
    â†“
SocketPal.Send() - P/Invoke
    â†“
send() ç³»ç»Ÿè°ƒç”¨
    â†“
TCP åè®®æ ˆ (å†…æ ¸)
  â€¢ åˆ†æ®µ (MSS)
  â€¢ æ·»åŠ  TCP Header
  â€¢ æ ¡éªŒå’Œ
    â†“
IP åè®®æ ˆ (å†…æ ¸)
  â€¢ æ·»åŠ  IP Header
  â€¢ è·¯ç”±é€‰æ‹©
    â†“
é“¾è·¯å±‚ (é©±åŠ¨)
  â€¢ æ·»åŠ ä»¥å¤ªç½‘å¸§å¤´
  â€¢ MAC åœ°å€
    â†“
ç‰©ç†å±‚ (ç½‘å¡)
  â€¢ ç”µä¿¡å·/å…‰ä¿¡å·
    â†“
ç½‘ç»œä¼ è¾“
    â†“
æœåŠ¡å™¨
```

#### **æ¥æ”¶æ•°æ®æµç¨‹**ï¼ˆå®Œå…¨ç›¸åï¼‰

```
æœåŠ¡å™¨å‘é€
    â†“
ç‰©ç†å±‚ (ç½‘å¡)
    â†“
é“¾è·¯å±‚ (é©±åŠ¨)
    â†“
IP åè®®æ ˆ
    â†“
TCP åè®®æ ˆ
  â€¢ ç¡®è®¤ (ACK)
  â€¢ é‡ç»„
    â†“
recv() ç³»ç»Ÿè°ƒç”¨
    â†“
Socket.ReceiveAsync()
    â†“
NetworkStream.ReadAsync()
    â†“
ManagedWebSocket.ReceiveAsyncPrivate()
  â€¢ è§£æ Frame Header
  â€¢ Unmask (å¦‚æœéœ€è¦)
  â€¢ å¤„ç† Ping/Pong (è‡ªåŠ¨)
  â€¢ ç»„è£…åˆ†ç‰‡æ¶ˆæ¯
    â†“
ä½ çš„ä»£ç :
  await ws.ReceiveAsync(buffer, ct);
```

---

## ğŸ’¡ **å…³é”®ç†è§£**

### **Socket å’Œ TCP çš„å…³ç³»**

```
Socket â‰  TCP

Socket æ˜¯:
  â€¢ ç¼–ç¨‹æ¥å£ (API)
  â€¢ æ“ä½œç³»ç»Ÿæä¾›çš„æŠ½è±¡
  â€¢ å¯ä»¥ç”¨äº TCPã€UDPã€åŸå§‹ IP

TCP æ˜¯:
  â€¢ ä¼ è¾“å±‚åè®®
  â€¢ æ“ä½œç³»ç»Ÿå†…æ ¸å®ç°
  â€¢ æä¾›å¯é çš„å­—èŠ‚æµæœåŠ¡

å…³ç³»:
  Socket socket = new Socket(SocketType.Stream, ProtocolType.Tcp);
  socket.Connect(...);
  
  è¿™è¡Œä»£ç ï¼š
  1. åˆ›å»ºäº†ä¸€ä¸ª Socket å¯¹è±¡ (ç¼–ç¨‹æ¥å£)
  2. å†…éƒ¨ä½¿ç”¨ TCP åè®® (ä¼ è¾“å±‚å®ç°)
  3. Connect() è§¦å‘ TCP ä¸‰æ¬¡æ¡æ‰‹
```

### **HTTP å’Œ WebSocket çš„å…³ç³»**

```
WebSocket â‰  HTTP

ä½†æ˜¯:
  â€¢ WebSocket ä½¿ç”¨ HTTP å®Œæˆåˆå§‹æ¡æ‰‹
  â€¢ æ¡æ‰‹æˆåŠŸåå‡çº§ä¸º WebSocket åè®®
  â€¢ ä¹‹åä¸å†ä½¿ç”¨ HTTP

æµç¨‹:
  HTTP è¯·æ±‚ (Upgrade: websocket)
    â†“
  HTTP å“åº” (101 Switching Protocols)
    â†“
  åè®®åˆ‡æ¢
    â†“
  WebSocket Frame å¼€å§‹ä¼ è¾“
  (ä¸å†æ˜¯ HTTP äº†ï¼)
```

---

## ğŸ“ **å­¦ä¹ å»ºè®®**

### **é˜…è¯»æºç é¡ºåº**

```
1. ClientWebSocket.cs (200 è¡Œ)
   â†’ ç†è§£å¦‚ä½•å‘èµ·è¿æ¥
   
2. ManagedWebSocket.SendFrameAsync() (100 è¡Œ)
   â†’ ç†è§£ Frame å¦‚ä½•æ„å»º
   
3. ManagedWebSocket.ReceiveAsyncPrivate() (150 è¡Œ)
   â†’ ç†è§£ Frame å¦‚ä½•è§£æ
   
4. ManagedWebSocket.HandleReceivedPingPongAsync() (50 è¡Œ)
   â†’ â­ ç†è§£ Ping/Pong è‡ªåŠ¨å¤„ç†
   
5. Socket.Connect() (50 è¡Œ)
   â†’ ç†è§£å¦‚ä½•è§¦å‘ TCP è¿æ¥
```

### **å®éªŒå»ºè®®**

```csharp
// 1. æ‰“å° WebSocket Frame
ManagedWebSocket å†…éƒ¨æ·»åŠ æ—¥å¿—:

private async ValueTask SendFrameAsync(...) {
    Console.WriteLine($"Sending Frame: Opcode={opcode}, Payload={payload.Length} bytes");
    // ... åŸå§‹ä»£ç 
}

// 2. è§‚å¯Ÿ Ping/Pong
å¯ç”¨ .NET è¯Šæ–­:

dotnet-counters monitor --process-id <pid> System.Net.WebSockets

// 3. æŠ“åŒ…åˆ†æ
ä½¿ç”¨ Wireshark è¿‡æ»¤:
  tcp.port == 8080
  
è§‚å¯Ÿ:
  â€¢ TCP ä¸‰æ¬¡æ¡æ‰‹
  â€¢ HTTP Upgrade
  â€¢ WebSocket Frames
  â€¢ Ping/Pong å¸§
```

---

éœ€è¦æˆ‘è¿›ä¸€æ­¥è§£é‡Šï¼š

1. æŸä¸€å±‚çš„è¯¦ç»†å®ç°ï¼Ÿ
2. å¦‚ä½•åœ¨ Unity ä¸­åº”ç”¨è¿™äº›çŸ¥è¯†ï¼Ÿ
3. å¦‚ä½•è‡ªå·±å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ WebSocketï¼Ÿ